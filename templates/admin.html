<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section-header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .btn-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            opacity: 0.9;
            color: white;
        }
        .video-table img {
            max-width: 50px;
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-gear-fill"></i> LMS - 管理画面
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> {{ session.username }}
                </span>
                <a href="/dashboard" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-house"></i> ダッシュボード
                </a>
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> ログアウト
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 動画管理セクション -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-collection-play"></i> 動画管理</h3>
            </div>
            
            <button class="btn btn-gradient mb-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-upload"></i> 新しい動画をアップロード
            </button>

            <div class="table-responsive">
                <table class="table table-hover video-table">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>タイトル</th>
                            <th>説明</th>
                            <th>ファイル名</th>
                            <th>アップロード日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for video in videos %}
                        <tr>
                            <td>{{ video.id }}</td>
                            <td>{{ video.title }}</td>
                            <td>{{ video.description or '-' }}</td>
                            <td><small class="text-muted">{{ video.filename }}</small></td>
                            <td>{{ video.created_at.split('.')[0] if '.' in video.created_at else video.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editVideo({{ video.id }}, '{{ video.title }}', '{{ video.description or '' }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVideo({{ video.id }}, '{{ video.title }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ユーザー管理セクション -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-people"></i> ユーザー管理</h3>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ユーザー名</th>
                            <th>メール</th>
                            <th>登録日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.created_at.split('.')[0] if '.' in user.created_at else user.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white" onclick="viewUserStats({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-bar-chart"></i> 視聴統計
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- アップロードモーダル -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">動画をアップロード</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="videoTitle" class="form-label">タイトル *</label>
                            <input type="text" class="form-control" id="videoTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="videoDescription" class="form-label">説明</label>
                            <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="videoFile" class="form-label">動画ファイル * (MP4, AVI, MOV, MKV, WebM)</label>
                            <input type="file" class="form-control" id="videoFile" accept="video/*" required>
                        </div>
                        <div class="progress mb-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-gradient" onclick="uploadVideo()">アップロード</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">動画を編集</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVideoId">
                    <div class="mb-3">
                        <label for="editVideoTitle" class="form-label">タイトル *</label>
                        <input type="text" class="form-control" id="editVideoTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVideoDescription" class="form-label">説明</label>
                        <textarea class="form-control" id="editVideoDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-gradient" onclick="updateVideo()">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー統計モーダル -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle">ユーザー視聴統計</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsModalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">読み込み中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 動画アップロード
        async function uploadVideo() {
            const title = document.getElementById('videoTitle').value;
            const description = document.getElementById('videoDescription').value;
            const file = document.getElementById('videoFile').files[0];
            
            if (!title || !file) {
                alert('タイトルと動画ファイルは必須です');
                return;
            }
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('video', file);
            
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('動画のアップロードに成功しました！');
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('アップロード中にエラーが発生しました: ' + error);
            }
        }

        // 動画編集
        function editVideo(id, title, description) {
            document.getElementById('editVideoId').value = id;
            document.getElementById('editVideoTitle').value = title;
            document.getElementById('editVideoDescription').value = description;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function updateVideo() {
            const id = document.getElementById('editVideoId').value;
            const title = document.getElementById('editVideoTitle').value;
            const description = document.getElementById('editVideoDescription').value;
            
            try {
                const response = await fetch(`/api/admin/update/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('動画の更新に成功しました！');
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('更新中にエラーが発生しました: ' + error);
            }
        }

        // 動画削除
        async function deleteVideo(id, title) {
            if (!confirm(`「${title}」を削除してもよろしいですか？\nこの操作は取り消せません。`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/delete/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('動画の削除に成功しました');
                    location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            } catch (error) {
                alert('削除中にエラーが発生しました: ' + error);
            }
        }

        // ユーザー視聴統計
        async function viewUserStats(userId, username) {
            document.getElementById('statsModalTitle').textContent = `${username} の視聴統計`;
            const modalBody = document.getElementById('statsModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
            
            try {
                const response = await fetch(`/api/admin/user-stats/${userId}`);
                const stats = await response.json();
                
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>動画タイトル</th><th>進捗</th><th>最終視聴日</th></tr></thead><tbody>';
                
                stats.forEach(stat => {
                    const progress = stat.progress_percent || 0;
                    const statusBadge = progress >= 95 ? 
                        '<span class="badge bg-success">完了</span>' :
                        progress > 0 ? 
                        '<span class="badge bg-warning">視聴中</span>' :
                        '<span class="badge bg-secondary">未視聴</span>';
                    
                    html += `<tr>
                        <td>${stat.title}</td>
                        <td>
                            ${statusBadge}
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${Math.round(progress)}%</small>
                        </td>
                        <td>${stat.updated_at ? stat.updated_at.split('.')[0] : '-'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = '<div class="alert alert-danger">統計の読み込みに失敗しました</div>';
            }
        }
    </script>
</body>
</html>
