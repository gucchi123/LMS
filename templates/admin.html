<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section-header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .btn-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            opacity: 0.9;
            color: white;
        }
        .video-table img {
            max-width: 50px;
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: white;
        }
        .category-tree {
            padding-left: 0;
            list-style: none;
        }
        .category-tree li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-tree li:hover {
            background-color: #f8f9fa;
        }
        .category-tree .subcategory {
            padding-left: 30px;
            background-color: #fafafa;
        }
        .category-icon-preview {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .color-picker-wrapper input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            cursor: pointer;
        }
        /* æ¥­ç¨®ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡é–¢é€£ */
        .industry-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: white;
            margin: 2px;
        }
        .access-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            background-color: #e9ecef;
            color: #495057;
            margin: 1px;
        }
        .access-public {
            background-color: #28a745;
            color: white;
        }
        .access-restricted {
            background-color: #ffc107;
            color: #212529;
        }
        .category-access-info {
            font-size: 0.8rem;
            margin-top: 4px;
        }
        .industry-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .industry-card:hover {
            background-color: #f8f9fa;
        }
        .access-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .access-checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
        }
        .access-checkbox-item:hover {
            background-color: #f8f9fa;
        }
        .access-checkbox-item.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-gear-fill"></i> LMS - ç®¡ç†ç”»é¢
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> {{ session.username }}
                </span>
                <a href="/courses" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-collection-play"></i> ã‚³ãƒ¼ã‚¹
                </a>
                <a href="/chat" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-chat-dots"></i> AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
                </a>
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- å‹•ç”»ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-collection-play"></i> å‹•ç”»ç®¡ç†</h3>
            </div>
            
            <button class="btn btn-gradient mb-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-upload"></i> æ–°ã—ã„å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>

            <div class="table-responsive">
                <table class="table table-hover video-table">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                            <th>èª¬æ˜</th>
                            <th>æ–‡å­—èµ·ã“ã—</th>
                            <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for video in videos %}
                        <tr>
                            <td>{{ video.id }}</td>
                            <td>{{ video.title }}</td>
                            <td>
                                {% if video.category_name %}
                                <span class="badge bg-primary">{{ video.category_name }}</span>
                                {% else %}
                                <span class="badge bg-secondary">æœªåˆ†é¡</span>
                                {% endif %}
                            </td>
                            <td>{{ video.description or '-' }}</td>
                            <td>
                                <span id="transcription-status-{{ video.id }}">
                                    {% if video.transcription_status == 'completed' %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> å®Œäº†</span>
                                    {% elif video.transcription_status == 'processing' %}
                                    <span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>
                                    {% elif video.transcription_status == 'pending' %}
                                    <span class="badge bg-info"><i class="bi bi-clock"></i> å¾…æ©Ÿä¸­</span>
                                    {% elif video.transcription_status == 'failed' %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±æ•—</span>
                                    {% else %}
                                    <span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>
                                    {% endif %}
                                </span>
                                <button class="btn btn-sm btn-outline-primary ms-1" onclick="startTranscription({{ video.id }})" 
                                        id="transcribe-btn-{{ video.id }}"
                                        {% if video.transcription_status == 'processing' %}disabled{% endif %}>
                                    <i class="bi bi-mic"></i>
                                </button>
                            </td>
                            <td>{{ video.created_at.split('.')[0] if '.' in video.created_at else video.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editVideo({{ video.id }}, '{{ video.title }}', '{{ video.description or '' }}', {{ video.category_id or 'null' }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVideo({{ video.id }}, '{{ video.title }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-folder"></i> ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</h3>
            </div>
            
            <button class="btn btn-gradient mb-3" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCategoryModal()">
                <i class="bi bi-plus-circle"></i> æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ 
            </button>

            <div class="row">
                <div class="col-12">
                    <ul class="category-tree">
                        {% for category in categories if category.parent_id is none %}
                        <li class="parent-category">
                            <div class="d-flex align-items-center flex-grow-1">
                                <i class="{{ category.icon }} category-icon-preview" style="color: {{ category.color }}"></i>
                                <div class="flex-grow-1">
                                    <strong>{{ category.name }}</strong>
                                    <div class="category-access-info">
                                        {% if category_access[category.id] %}
                                        <span class="access-badge access-restricted">
                                            <i class="bi bi-lock"></i> åˆ¶é™ã‚ã‚Š
                                        </span>
                                        {% for ind in category_access[category.id] %}
                                        <span class="access-badge">{{ ind.name }}</span>
                                        {% endfor %}
                                        {% else %}
                                        <span class="access-badge access-public">
                                            <i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-warning" onclick="openAccessModal({{ category.id }}, '{{ category.name }}')">
                                    <i class="bi bi-shield-lock"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="openCategoryModal({{ category.id }}, '{{ category.name }}', '{{ category.description or '' }}', '{{ category.icon }}', '{{ category.color }}', null, {{ category.display_order }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="openCategoryModal(null, '', '', 'bi-folder', '{{ category.color }}', {{ category.id }})">
                                    <i class="bi bi-plus"></i> ã‚µãƒ–
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ category.id }}, '{{ category.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </li>
                        {% for subcategory in categories if subcategory.parent_id == category.id %}
                        <li class="subcategory">
                            <div class="d-flex align-items-center">
                                <i class="{{ subcategory.icon }} category-icon-preview" style="color: {{ subcategory.color }}"></i>
                                <div>
                                    <strong>{{ subcategory.name }}</strong>
                                    <br><small class="text-muted">{{ subcategory.description or '' }}</small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="openCategoryModal({{ subcategory.id }}, '{{ subcategory.name }}', '{{ subcategory.description or '' }}', '{{ subcategory.icon }}', '{{ subcategory.color }}', {{ subcategory.parent_id }}, {{ subcategory.display_order }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ subcategory.id }}, '{{ subcategory.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                    {% if not categories %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æ¥­ç¨®ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-building"></i> æ¥­ç¨®ç®¡ç†</h3>
                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#industryModal" onclick="openIndustryModal()">
                    <i class="bi bi-plus-lg"></i> æ–°ã—ã„æ¥­ç¨®ã‚’è¿½åŠ 
                </button>
            </div>
            
            <div class="row">
                {% for industry in industries %}
                <div class="col-md-6 col-lg-4">
                    <div class="industry-card">
                        <div class="d-flex align-items-center">
                            <i class="{{ industry.icon }}" style="font-size: 1.5rem; color: {{ industry.color }}; margin-right: 10px;"></i>
                            <div>
                                <strong>{{ industry.name }}</strong>
                                <small class="text-muted d-block">{{ industry.name_en }}</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openIndustryModal({{ industry.id }}, '{{ industry.name }}', '{{ industry.name_en }}', '{{ industry.description or '' }}', '{{ industry.icon }}', '{{ industry.color }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIndustry({{ industry.id }}, '{{ industry.name }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if not industries %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> æ¥­ç¨®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„æ¥­ç¨®ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
            </div>
            {% endif %}
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openUserModal()">
                    <i class="bi bi-person-plus"></i> æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th>ãƒ¡ãƒ¼ãƒ«</th>
                            <th>æ¥­ç¨®</th>
                            <th>ä¼šç¤¾å</th>
                            <th>æ¨©é™</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.industry_name %}
                                <span class="badge bg-secondary">{{ user.industry_name }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ user.company_name or '-' }}</td>
                            <td>
                                {% if user.id == session.user_id %}
                                <span class="badge bg-primary">ã‚ãªãŸ</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.split('.')[0] if '.' in user.created_at else user.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white" onclick="viewUserStats({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-bar-chart"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editUser({{ user.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if user.id != session.user_id %}
                                <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="videoTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" class="form-control" id="videoTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="videoDescription" class="form-label">èª¬æ˜</label>
                            <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="videoCategory" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                            <select class="form-select" id="videoCategory">
                                <option value="">æœªåˆ†é¡</option>
                                {% for category in categories if category.parent_id is none %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% for subcategory in categories if subcategory.parent_id == category.id %}
                                <option value="{{ subcategory.id }}">â”” {{ subcategory.name }}</option>
                                {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="videoFile" class="form-label">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« * (MP4, AVI, MOV, MKV, WebM)</label>
                            <input type="file" class="form-control" id="videoFile" accept="video/*" required>
                        </div>
                        <div class="progress mb-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="uploadVideo()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‹•ç”»ã‚’ç·¨é›†</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVideoId">
                    <div class="mb-3">
                        <label for="editVideoTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                        <input type="text" class="form-control" id="editVideoTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVideoDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="editVideoDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editVideoCategory" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select class="form-select" id="editVideoCategory">
                            <option value="">æœªåˆ†é¡</option>
                            {% for category in categories if category.parent_id is none %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% for subcategory in categories if subcategory.parent_id == category.id %}
                            <option value="{{ subcategory.id }}">â”” {{ subcategory.name }}</option>
                            {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="updateVideo()">æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–è´çµ±è¨ˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsModalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼å *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryParent" class="form-label">è¦ªã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select class="form-select" id="categoryParent">
                            <option value="">ãªã—ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰</option>
                            {% for category in categories if category.parent_id is none %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="categoryIcon" class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
                            <select class="form-select" id="categoryIcon" onchange="updateIconPreview()">
                                <option value="bi-folder">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼</option>
                                <option value="bi-book">ğŸ“š æœ¬</option>
                                <option value="bi-lightbulb">ğŸ’¡ é›»çƒ</option>
                                <option value="bi-briefcase">ğŸ’¼ ãƒ–ãƒªãƒ¼ãƒ•ã‚±ãƒ¼ã‚¹</option>
                                <option value="bi-chat-dots">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</option>
                                <option value="bi-gear">âš™ï¸ æ­¯è»Š</option>
                                <option value="bi-graph-up">ğŸ“ˆ ã‚°ãƒ©ãƒ•</option>
                                <option value="bi-bar-chart">ğŸ“Š æ£’ã‚°ãƒ©ãƒ•</option>
                                <option value="bi-collection">ğŸ“‘ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</option>
                                <option value="bi-people">ğŸ‘¥ äººã€…</option>
                                <option value="bi-rocket">ğŸš€ ãƒ­ã‚±ãƒƒãƒˆ</option>
                                <option value="bi-star">â­ æ˜Ÿ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="categoryColor" class="form-label">ã‚«ãƒ©ãƒ¼</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="categoryColor" value="#667eea">
                                <span id="categoryColorHex">#667eea</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="categoryOrder" class="form-label">è¡¨ç¤ºé †</label>
                        <input type="number" class="form-control" id="categoryOrder" value="0" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                        <div class="d-flex align-items-center p-3 border rounded">
                            <i id="iconPreview" class="bi-folder category-icon-preview" style="color: #667eea; font-size: 2rem;"></i>
                            <span id="namePreview" class="ms-2 fw-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼å</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveCategory()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¥­ç¨®ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="industryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="industryModalTitle">æ¥­ç¨®ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="industryId">
                    <div class="mb-3">
                        <label for="industryName" class="form-label">æ¥­ç¨®åï¼ˆæ—¥æœ¬èªï¼‰ *</label>
                        <input type="text" class="form-control" id="industryName" required placeholder="ä¾‹ï¼šå®¿æ³Š">
                    </div>
                    <div class="mb-3">
                        <label for="industryNameEn" class="form-label">æ¥­ç¨®åï¼ˆè‹±èªï¼‰</label>
                        <input type="text" class="form-control" id="industryNameEn" placeholder="ä¾‹ï¼šAccommodation">
                    </div>
                    <div class="mb-3">
                        <label for="industryDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="industryDescription" rows="2" placeholder="ä¾‹ï¼šå®¿æ³Šæ¥­ãƒ»ãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="industryIcon" class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
                            <select class="form-select" id="industryIcon">
                                <option value="bi-building">ğŸ¢ ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°</option>
                                <option value="bi-house-door">ğŸ  ä½å®…</option>
                                <option value="bi-shop">ğŸª ã‚·ãƒ§ãƒƒãƒ—</option>
                                <option value="bi-cup-hot">â˜• é£²é£Ÿ</option>
                                <option value="bi-heart-pulse">ğŸ’— ä»‹è­·</option>
                                <option value="bi-hospital">ğŸ¥ åŒ»ç™‚</option>
                                <option value="bi-mortarboard">ğŸ“ æ•™è‚²</option>
                                <option value="bi-truck">ğŸšš ç‰©æµ</option>
                                <option value="bi-gear">âš™ï¸ è£½é€ </option>
                                <option value="bi-laptop">ğŸ’» IT</option>
                                <option value="bi-bank">ğŸ¦ é‡‘è</option>
                                <option value="bi-cart">ğŸ›’ EC</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="industryColor" class="form-label">ã‚«ãƒ©ãƒ¼</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="industryColor" value="#667eea">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveIndustry()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="accessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock"></i> ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®š</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="accessCategoryId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼: <span id="accessCategoryName"></span></label>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">
                            <i class="bi bi-info-circle"></i> 
                            æ¥­ç¨®ã‚’é¸æŠã—ãªã„å ´åˆã¯ã€Œå…¨æ¥­ç¨®å…¬é–‹ã€ã¨ãªã‚Šã¾ã™ã€‚
                            é¸æŠã—ãŸæ¥­ç¨®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹æ¥­ç¨®</label>
                        <div id="accessIndustryList" class="access-checkbox-group">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <div id="accessPreview" class="p-3 border rounded">
                            <span class="access-badge access-public"><i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveAccessControl()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle"><i class="bi bi-person-plus"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="userUsername" class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å *</label>
                        <input type="text" class="form-control" id="userUsername" required placeholder="ä¾‹ï¼štanaka_hotel">
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" class="form-control" id="userEmail" required placeholder="ä¾‹ï¼štanaka@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span id="passwordRequiredMark">*</span></label>
                        <input type="password" class="form-control" id="userPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                        <small class="text-muted" id="passwordHint" style="display: none;">ç©ºæ¬„ã®å ´åˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“</small>
                    </div>
                    <div class="mb-3">
                        <label for="userIndustry" class="form-label">æ¥­ç¨®</label>
                        <select class="form-select" id="userIndustry">
                            <option value="">ãªã—ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰</option>
                            {% for industry in industries %}
                            <option value="{{ industry.id }}">{{ industry.name }} ({{ industry.name_en }})</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">æ¥­ç¨®ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ¥­ç¨®å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</small>
                    </div>
                    <div class="mb-3">
                        <label for="userCompany" class="form-label">ä¼šç¤¾å</label>
                        <input type="text" class="form-control" id="userCompany" placeholder="ä¾‹ï¼šã‚°ãƒ©ãƒ³ãƒ‰ãƒ›ãƒ†ãƒ«æ±äº¬">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="userIsAdmin">
                        <label class="form-check-label" for="userIsAdmin">ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸</label>
                        <small class="text-muted d-block">ç®¡ç†è€…ã¯å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã€ç®¡ç†ç”»é¢ã‚’ä½¿ç”¨ã§ãã¾ã™</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveUser()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ–‡å­—èµ·ã“ã—é–‹å§‹
        async function startTranscription(videoId) {
            if (!confirm('æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿå‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const statusSpan = document.getElementById(`transcription-status-${videoId}`);
            const btn = document.getElementById(`transcribe-btn-${videoId}`);
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            btn.disabled = true;
            statusSpan.innerHTML = '<span class="badge bg-info"><i class="bi bi-clock"></i> å¾…æ©Ÿä¸­</span>';
            
            try {
                const response = await fetch(`/api/admin/videos/${videoId}/transcribe`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusSpan.innerHTML = '<span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>';
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
                    pollTranscriptionStatus(videoId);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    statusSpan.innerHTML = '<span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>';
                    btn.disabled = false;
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
                statusSpan.innerHTML = '<span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>';
                btn.disabled = false;
            }
        }
        
        // æ–‡å­—èµ·ã“ã—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
        function pollTranscriptionStatus(videoId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/admin/videos/${videoId}/transcript-status`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const statusSpan = document.getElementById(`transcription-status-${videoId}`);
                        const btn = document.getElementById(`transcribe-btn-${videoId}`);
                        
                        if (data.status === 'completed') {
                            statusSpan.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å®Œäº†</span>';
                            btn.disabled = false;
                            clearInterval(interval);
                        } else if (data.status === 'failed') {
                            statusSpan.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±æ•—</span>';
                            btn.disabled = false;
                            clearInterval(interval);
                        } else if (data.status === 'processing') {
                            statusSpan.innerHTML = '<span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>';
                        }
                    }
                } catch (error) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 5000); // 5ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        }
        
        // å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadVideo() {
            const title = document.getElementById('videoTitle').value;
            const description = document.getElementById('videoDescription').value;
            const categoryId = document.getElementById('videoCategory').value;
            const file = document.getElementById('videoFile').files[0];
            
            if (!title || !file) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…é ˆã§ã™');
                return;
            }
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('category_id', categoryId);
            formData.append('video', file);
            
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // å‹•ç”»ç·¨é›†
        function editVideo(id, title, description, categoryId) {
            document.getElementById('editVideoId').value = id;
            document.getElementById('editVideoTitle').value = title;
            document.getElementById('editVideoDescription').value = description;
            document.getElementById('editVideoCategory').value = categoryId || '';
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function updateVideo() {
            const id = document.getElementById('editVideoId').value;
            const title = document.getElementById('editVideoTitle').value;
            const description = document.getElementById('editVideoDescription').value;
            const categoryId = document.getElementById('editVideoCategory').value;
            
            try {
                // å‹•ç”»æƒ…å ±ã‚’æ›´æ–°
                const response = await fetch(`/api/admin/update/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°
                await fetch(`/api/admin/videos/${id}/category`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_id: categoryId ? parseInt(categoryId) : null })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®æ›´æ–°ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // å‹•ç”»å‰Šé™¤
        async function deleteVideo(id, title) {
            if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/delete/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–è´çµ±è¨ˆ
        async function viewUserStats(userId, username) {
            document.getElementById('statsModalTitle').textContent = `${username} ã®è¦–è´çµ±è¨ˆ`;
            const modalBody = document.getElementById('statsModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
            
            try {
                const response = await fetch(`/api/admin/user-stats/${userId}`);
                const stats = await response.json();
                
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th><th>é€²æ—</th><th>æœ€çµ‚è¦–è´æ—¥</th></tr></thead><tbody>';
                
                stats.forEach(stat => {
                    const progress = stat.progress_percent || 0;
                    const statusBadge = progress >= 95 ? 
                        '<span class="badge bg-success">å®Œäº†</span>' :
                        progress > 0 ? 
                        '<span class="badge bg-warning">è¦–è´ä¸­</span>' :
                        '<span class="badge bg-secondary">æœªè¦–è´</span>';
                    
                    html += `<tr>
                        <td>${stat.title}</td>
                        <td>
                            ${statusBadge}
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${Math.round(progress)}%</small>
                        </td>
                        <td>${stat.updated_at ? stat.updated_at.split('.')[0] : '-'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = '<div class="alert alert-danger">çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ========== ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç† ==========

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCategoryModal(id = null, name = '', description = '', icon = 'bi-folder', color = '#667eea', parentId = null, displayOrder = 0) {
            document.getElementById('categoryId').value = id || '';
            document.getElementById('categoryName').value = name;
            document.getElementById('categoryDescription').value = description;
            document.getElementById('categoryIcon').value = icon;
            document.getElementById('categoryColor').value = color;
            document.getElementById('categoryColorHex').textContent = color;
            document.getElementById('categoryParent').value = parentId || '';
            document.getElementById('categoryOrder').value = displayOrder;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            updateIconPreview();
            document.getElementById('namePreview').textContent = name || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            document.getElementById('categoryModalTitle').textContent = id ? 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç·¨é›†' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ ';
            
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        }

        // ã‚¢ã‚¤ã‚³ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateIconPreview() {
            const icon = document.getElementById('categoryIcon').value;
            const color = document.getElementById('categoryColor').value;
            document.getElementById('iconPreview').className = icon + ' category-icon-preview';
            document.getElementById('iconPreview').style.color = color;
            document.getElementById('categoryColorHex').textContent = color;
        }

        // ã‚«ãƒ©ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
        document.getElementById('categoryColor').addEventListener('input', updateIconPreview);
        document.getElementById('categoryName').addEventListener('input', function() {
            document.getElementById('namePreview').textContent = this.value || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å';
        });

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¿å­˜
        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;
            const icon = document.getElementById('categoryIcon').value;
            const color = document.getElementById('categoryColor').value;
            const parentId = document.getElementById('categoryParent').value;
            const displayOrder = parseInt(document.getElementById('categoryOrder').value) || 0;
            
            if (!name) {
                alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼åã¯å¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                name,
                description,
                icon,
                color,
                parent_id: parentId ? parseInt(parentId) : null,
                display_order: displayOrder
            };
            
            try {
                const url = id ? `/api/admin/categories/${id}` : '/api/admin/categories';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤
        async function deleteCategory(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ç´ä»˜ã„ã¦ã„ã‚‹å‹•ç”»ã¯ã€Œæœªåˆ†é¡ã€ã«ãªã‚Šã¾ã™ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/categories/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ========== æ¥­ç¨®ç®¡ç† ==========

        // æ¥­ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let industriesCache = [];

        // æ¥­ç¨®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadIndustries() {
            try {
                const response = await fetch('/api/industries');
                industriesCache = await response.json();
                return industriesCache;
            } catch (error) {
                console.error('æ¥­ç¨®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return [];
            }
        }

        // æ¥­ç¨®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openIndustryModal(id = null, name = '', nameEn = '', description = '', icon = 'bi-building', color = '#667eea') {
            document.getElementById('industryId').value = id || '';
            document.getElementById('industryName').value = name;
            document.getElementById('industryNameEn').value = nameEn;
            document.getElementById('industryDescription').value = description;
            document.getElementById('industryIcon').value = icon;
            document.getElementById('industryColor').value = color;
            
            document.getElementById('industryModalTitle').textContent = id ? 'æ¥­ç¨®ã‚’ç·¨é›†' : 'æ¥­ç¨®ã‚’è¿½åŠ ';
        }

        // æ¥­ç¨®ã‚’ä¿å­˜
        async function saveIndustry() {
            const id = document.getElementById('industryId').value;
            const name = document.getElementById('industryName').value;
            const nameEn = document.getElementById('industryNameEn').value;
            const description = document.getElementById('industryDescription').value;
            const icon = document.getElementById('industryIcon').value;
            const color = document.getElementById('industryColor').value;
            
            if (!name) {
                alert('æ¥­ç¨®åã¯å¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                name,
                name_en: nameEn,
                description,
                icon,
                color
            };
            
            try {
                const url = id ? `/api/admin/industries/${id}` : '/api/admin/industries';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'æ¥­ç¨®ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¥­ç¨®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // æ¥­ç¨®ã‚’å‰Šé™¤
        async function deleteIndustry(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®æ¥­ç¨®ã«æ‰€å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/industries/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('æ¥­ç¨®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ========== ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç† ==========

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠã•ã‚Œã¦ã„ã‚‹æ¥­ç¨®ID
        let selectedIndustryIds = [];

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openAccessModal(categoryId, categoryName) {
            document.getElementById('accessCategoryId').value = categoryId;
            document.getElementById('accessCategoryName').textContent = categoryName;
            
            // æ¥­ç¨®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if (industriesCache.length === 0) {
                await loadIndustries();
            }
            
            // ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’å–å¾—
            try {
                const response = await fetch(`/api/admin/categories/${categoryId}/access`);
                const accessData = await response.json();
                selectedIndustryIds = accessData.industry_ids || [];
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                selectedIndustryIds = [];
            }
            
            // æ¥­ç¨®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            const container = document.getElementById('accessIndustryList');
            container.innerHTML = '';
            
            industriesCache.forEach(industry => {
                const isSelected = selectedIndustryIds.includes(industry.id);
                const item = document.createElement('div');
                item.className = 'access-checkbox-item' + (isSelected ? ' selected' : '');
                item.dataset.industryId = industry.id;
                item.innerHTML = `
                    <i class="${industry.icon}" style="color: ${industry.color}"></i>
                    <span>${industry.name}</span>
                `;
                item.onclick = function() {
                    toggleIndustrySelection(industry.id, this);
                };
                container.appendChild(item);
            });
            
            updateAccessPreview();
            
            new bootstrap.Modal(document.getElementById('accessModal')).show();
        }

        // æ¥­ç¨®é¸æŠã®ãƒˆã‚°ãƒ«
        function toggleIndustrySelection(industryId, element) {
            const index = selectedIndustryIds.indexOf(industryId);
            if (index === -1) {
                selectedIndustryIds.push(industryId);
                element.classList.add('selected');
            } else {
                selectedIndustryIds.splice(index, 1);
                element.classList.remove('selected');
            }
            updateAccessPreview();
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateAccessPreview() {
            const previewContainer = document.getElementById('accessPreview');
            
            if (selectedIndustryIds.length === 0) {
                previewContainer.innerHTML = '<span class="access-badge access-public"><i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹</span>';
            } else {
                const selectedIndustries = industriesCache.filter(i => selectedIndustryIds.includes(i.id));
                let html = '<span class="access-badge access-restricted"><i class="bi bi-lock"></i> åˆ¶é™ã‚ã‚Š</span> ';
                html += selectedIndustries.map(i => `<span class="access-badge">${i.name}</span>`).join(' ');
                previewContainer.innerHTML = html;
            }
        }

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¿å­˜
        async function saveAccessControl() {
            const categoryId = document.getElementById('accessCategoryId').value;
            
            try {
                const response = await fetch(`/api/admin/categories/${categoryId}/access`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        industry_ids: selectedIndustryIds
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ¥­ç¨®ã‚’èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', function() {
            loadIndustries();
        });

        // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ==========

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openUserModal(id = null) {
            document.getElementById('userId').value = id || '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIndustry').value = '';
            document.getElementById('userCompany').value = '';
            document.getElementById('userIsAdmin').checked = false;
            
            // æ–°è¦ä½œæˆæ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ
            if (id) {
                document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-gear"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†';
                document.getElementById('passwordRequiredMark').style.display = 'none';
                document.getElementById('passwordHint').style.display = 'block';
                document.getElementById('userPassword').removeAttribute('required');
            } else {
                document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-plus"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ';
                document.getElementById('passwordRequiredMark').style.display = 'inline';
                document.getElementById('passwordHint').style.display = 'none';
                document.getElementById('userPassword').setAttribute('required', 'required');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
        async function editUser(userId) {
            openUserModal(userId);
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const user = await response.json();
                
                if (response.ok) {
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userIndustry').value = user.industry_id || '';
                    document.getElementById('userCompany').value = user.company_name || '';
                    document.getElementById('userIsAdmin').checked = user.is_admin;
                    
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + user.error);
                }
            } catch (error) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜
        async function saveUser() {
            const id = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const industryId = document.getElementById('userIndustry').value;
            const companyName = document.getElementById('userCompany').value;
            const isAdmin = document.getElementById('userIsAdmin').checked;
            
            if (!username || !email) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                return;
            }
            
            if (!id && !password) {
                alert('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                username,
                email,
                industry_id: industryId ? parseInt(industryId) : null,
                company_name: companyName,
                is_admin: isAdmin
            };
            
            if (password) {
                data.password = password;
            }
            
            try {
                const url = id ? `/api/admin/users/${id}` : '/api/admin/users';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        async function deleteUser(userId, username) {
            if (!confirm(`ã€Œ${username}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦–è´å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }
    </script>
</body>
</html>
