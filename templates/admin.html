<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - LMS</title>
    {% include 'ga4_tracking.html' %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section-header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .btn-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            opacity: 0.9;
            color: white;
        }
        .video-table img {
            max-width: 50px;
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: white;
        }
        .category-tree {
            padding-left: 0;
            list-style: none;
        }
        .category-tree li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-tree li:hover {
            background-color: #f8f9fa;
        }
        .category-tree .subcategory {
            padding-left: 30px;
            background-color: #fafafa;
        }
        .category-icon-preview {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .color-picker-wrapper input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            cursor: pointer;
        }
        /* æ¥­ç¨®ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡é–¢é€£ */
        .industry-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: white;
            margin: 2px;
        }
        .access-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            background-color: #e9ecef;
            color: #495057;
            margin: 1px;
        }
        .access-public {
            background-color: #28a745;
            color: white;
        }
        .access-restricted {
            background-color: #ffc107;
            color: #212529;
        }
        .category-access-info {
            font-size: 0.8rem;
            margin-top: 4px;
        }
        .industry-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .industry-card:hover {
            background-color: #f8f9fa;
        }
        .access-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .access-checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
        }
        .access-checkbox-item:hover {
            background-color: #f8f9fa;
        }
        .access-checkbox-item.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/courses">
                <i class="bi bi-mortarboard-fill"></i> Rakuten AI for Business ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> {{ session.username }}
                    <span class="badge bg-light text-dark ms-1">{{ session.role or 'admin' }}</span>
                </span>
                <a href="/admin/user-progress" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-people-fill"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–è´çŠ¶æ³
                </a>
                <a href="/admin/video-analytics" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-camera-video"></i> å‹•ç”»è¦–è´åˆ†æ
                </a>
                <a href="/admin/analytics" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-graph-up"></i> ã‚¢ã‚¯ã‚»ã‚¹åˆ†æ
                </a>
                <a href="/admin/qa-analytics" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-chat-square-text"></i> Q&Aåˆ†æ
                </a>
                <a href="/courses" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-collection-play"></i> ã‚³ãƒ¼ã‚¹
                </a>
                <a href="/my-progress" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-graph-up-arrow"></i> ãƒã‚¤è¦–è´çŠ¶æ³
                </a>
                <a href="/chat" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-chat-dots"></i> AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
                </a>
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- å‹•ç”»ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-collection-play"></i> å‹•ç”»ç®¡ç†</h3>
            </div>
            
            <button class="btn btn-gradient mb-3" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-upload"></i> æ–°ã—ã„å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>

            <div class="table-responsive">
                <table class="table table-hover video-table">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                            <th>èª¬æ˜</th>
                            <th>æ–‡å­—èµ·ã“ã—</th>
                            <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for video in videos %}
                        <tr>
                            <td>{{ video.id }}</td>
                            <td>{{ video.title }}</td>
                            <td>
                                {% if video.category_name %}
                                <span class="badge bg-primary">{{ video.category_name }}</span>
                                {% else %}
                                <span class="badge bg-secondary">æœªåˆ†é¡</span>
                                {% endif %}
                            </td>
                            <td>{{ video.description or '-' }}</td>
                            <td>
                                <span id="transcription-status-{{ video.id }}">
                                    {% if video.transcription_status == 'completed' %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> å®Œäº†</span>
                                    {% elif video.transcription_status == 'processing' %}
                                    <span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>
                                    {% elif video.transcription_status == 'pending' %}
                                    <span class="badge bg-info"><i class="bi bi-clock"></i> å¾…æ©Ÿä¸­</span>
                                    {% elif video.transcription_status == 'failed' %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±æ•—</span>
                                    {% else %}
                                    <span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>
                                    {% endif %}
                                </span>
                                <button class="btn btn-sm btn-outline-primary ms-1" onclick="startTranscription({{ video.id }})" 
                                        id="transcribe-btn-{{ video.id }}"
                                        {% if video.transcription_status == 'processing' %}disabled{% endif %}>
                                    <i class="bi bi-mic"></i>
                                </button>
                            </td>
                            <td>{{ video.created_at.split('.')[0] if '.' in video.created_at else video.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editVideo({{ video.id }}, '{{ video.title }}', '{{ video.description or '' }}', {{ video.category_id or 'null' }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVideo({{ video.id }}, '{{ video.title }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header">
                <h3><i class="bi bi-folder"></i> ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</h3>
            </div>
            
            <button class="btn btn-gradient mb-3" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCategoryModal()">
                <i class="bi bi-plus-circle"></i> æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ 
            </button>

            <div class="row">
                <div class="col-12">
                    <ul class="category-tree">
                        {% for category in categories if category.parent_id is none %}
                        <li class="parent-category">
                            <div class="d-flex align-items-center flex-grow-1">
                                <i class="{{ category.icon }} category-icon-preview" style="color: {{ category.color }}"></i>
                                <div class="flex-grow-1">
                                    <strong>{{ category.name }}</strong>
                                    <div class="category-access-info">
                                        {% if category_access[category.id] %}
                                        <span class="access-badge access-restricted">
                                            <i class="bi bi-lock"></i> åˆ¶é™ã‚ã‚Š
                                        </span>
                                        {% for ind in category_access[category.id] %}
                                        <span class="access-badge">{{ ind.name }}</span>
                                        {% endfor %}
                                        {% else %}
                                        <span class="access-badge access-public">
                                            <i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-warning" onclick="openAccessModal({{ category.id }}, '{{ category.name }}')">
                                    <i class="bi bi-shield-lock"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="openCategoryModal({{ category.id }}, '{{ category.name }}', '{{ category.description or '' }}', '{{ category.icon }}', '{{ category.color }}', null, {{ category.display_order }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="openCategoryModal(null, '', '', 'bi-folder', '{{ category.color }}', {{ category.id }})">
                                    <i class="bi bi-plus"></i> ã‚µãƒ–
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ category.id }}, '{{ category.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </li>
                        {% for subcategory in categories if subcategory.parent_id == category.id %}
                        <li class="subcategory">
                            <div class="d-flex align-items-center">
                                <i class="{{ subcategory.icon }} category-icon-preview" style="color: {{ subcategory.color }}"></i>
                                <div>
                                    <strong>{{ subcategory.name }}</strong>
                                    <br><small class="text-muted">{{ subcategory.description or '' }}</small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="openCategoryModal({{ subcategory.id }}, '{{ subcategory.name }}', '{{ subcategory.description or '' }}', '{{ subcategory.icon }}', '{{ subcategory.color }}', {{ subcategory.parent_id }}, {{ subcategory.display_order }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ subcategory.id }}, '{{ subcategory.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                    {% if not categories %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æ¥­ç¨®ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-building"></i> æ¥­ç¨®ç®¡ç†</h3>
                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#industryModal" onclick="openIndustryModal()">
                    <i class="bi bi-plus-lg"></i> æ–°ã—ã„æ¥­ç¨®ã‚’è¿½åŠ 
                </button>
            </div>
            
            <div class="row">
                {% for industry in industries %}
                <div class="col-md-6 col-lg-4">
                    <div class="industry-card">
                        <div class="d-flex align-items-center">
                            <i class="{{ industry.icon }}" style="font-size: 1.5rem; color: {{ industry.color }}; margin-right: 10px;"></i>
                            <div>
                                <strong>{{ industry.name }}</strong>
                                <small class="text-muted d-block">{{ industry.name_en }}</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openIndustryModal({{ industry.id }}, '{{ industry.name }}', '{{ industry.name_en }}', '{{ industry.description or '' }}', '{{ industry.icon }}', '{{ industry.color }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIndustry({{ industry.id }}, '{{ industry.name }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if not industries %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> æ¥­ç¨®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°ã—ã„æ¥­ç¨®ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
            </div>
            {% endif %}
        </div>

        <!-- ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (super_adminã®ã¿) -->
        {% if current_role == 'super_admin' %}
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-buildings"></i> ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†</h3>
                <button class="btn btn-gradient" onclick="openTenantModal()">
                    <i class="bi bi-plus-lg"></i> æ–°ã—ã„ãƒ†ãƒŠãƒ³ãƒˆã‚’è¿½åŠ 
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ãƒ†ãƒŠãƒ³ãƒˆå</th>
                            <th>æ¥­ç¨®</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tenant in tenants %}
                        <tr>
                            <td>{{ tenant.id }}</td>
                            <td>{{ tenant.name }}</td>
                            <td>
                                {% if tenant.industry_name %}
                                <span class="badge bg-secondary">{{ tenant.industry_name }}</span>
                                {% else %}-{% endif %}
                            </td>
                            <td>{{ tenant.created_at.split('.')[0] if tenant.created_at and '.' in tenant.created_at else tenant.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openTenantModal({{ tenant.id }}, '{{ tenant.name }}', {{ tenant.industry_id or 'null' }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTenant({{ tenant.id }}, '{{ tenant.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- éƒ¨ç½²ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-diagram-3"></i> éƒ¨ç½²ç®¡ç†</h3>
                <button class="btn btn-gradient" onclick="openDepartmentModal()">
                    <i class="bi bi-plus-lg"></i> æ–°ã—ã„éƒ¨ç½²ã‚’è¿½åŠ 
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>éƒ¨ç½²å</th>
                            <th>ãƒ†ãƒŠãƒ³ãƒˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept in departments %}
                        <tr>
                            <td>{{ dept.id }}</td>
                            <td>{{ dept.name }}</td>
                            <td>{{ dept.tenant_name }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openDepartmentModal({{ dept.id }}, '{{ dept.name }}', {{ dept.tenant_id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDepartment({{ dept.id }}, '{{ dept.name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-people"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                <div>
                    <a href="/api/admin/users/export-csv" class="btn btn-outline-success btn-sm me-1">
                        <i class="bi bi-download"></i> CSVå‡ºåŠ›
                    </a>
                    <button class="btn btn-outline-primary btn-sm me-1" onclick="document.getElementById('csvImportFile').click()">
                        <i class="bi bi-upload"></i> CSVä¸€æ‹¬ç™»éŒ²
                    </button>
                    <input type="file" id="csvImportFile" accept=".csv" style="display:none" onchange="importCSV(this)">
                    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openUserModal()">
                        <i class="bi bi-person-plus"></i> æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th>ãƒ¡ãƒ¼ãƒ«</th>
                            <th>ãƒ­ãƒ¼ãƒ«</th>
                            <th>ãƒ†ãƒŠãƒ³ãƒˆ</th>
                            <th>éƒ¨ç½²</th>
                            <th>æ¥­ç¨®</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>
                                {{ user.username }}
                                {% if user.id == session.user_id %}
                                <span class="badge bg-primary">ã‚ãªãŸ</span>
                                {% endif %}
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.role == 'super_admin' %}
                                <span class="badge bg-danger">super_admin</span>
                                {% elif user.role == 'company_admin' %}
                                <span class="badge bg-warning text-dark">company_admin</span>
                                {% else %}
                                <span class="badge bg-secondary">user</span>
                                {% endif %}
                            </td>
                            <td>{{ user.tenant_name or '-' }}</td>
                            <td>{{ user.department_name or '-' }}</td>
                            <td>
                                {% if user.industry_name %}
                                <span class="badge bg-info text-dark">{{ user.industry_name }}</span>
                                {% else %}-{% endif %}
                            </td>
                            <td>{{ user.created_at.split('.')[0] if '.' in user.created_at else user.created_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white" onclick="viewUserStats({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-bar-chart"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editUser({{ user.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if user.id != session.user_id %}
                                <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å¤–éƒ¨ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-book"></i> å¤–éƒ¨ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†</h3>
                <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#knowledgeUploadModal">
                    <i class="bi bi-cloud-upload"></i> Markdownã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
            
            <p class="text-muted mb-3">
                <i class="bi bi-info-circle"></i> 
                æ¥­ç¨®åˆ¥ã®ãƒŠãƒ¬ãƒƒã‚¸ï¼ˆMarkdownãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
            </p>

            <div id="knowledgeSourceList">
                {% if knowledge_list %}
                {% set sources = {} %}
                {% for k in knowledge_list %}
                    {% if k.source_file not in sources %}
                        {% set _ = sources.update({k.source_file: {'industry_name': k.industry_name, 'count': 0, 'created_at': k.created_at}}) %}
                    {% endif %}
                    {% set _ = sources[k.source_file].update({'count': sources[k.source_file].count + 1}) %}
                {% endfor %}
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«</th>
                                <th>æ¥­ç¨®</th>
                                <th>ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°</th>
                                <th>ç™»éŒ²æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for source_file, info in sources.items() %}
                            <tr>
                                <td>
                                    <i class="bi bi-file-earmark-text text-primary"></i>
                                    {{ source_file }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ info.industry_name or 'æœªè¨­å®š' }}</span>
                                </td>
                                <td>{{ info.count }} ã‚»ã‚¯ã‚·ãƒ§ãƒ³</td>
                                <td>{{ info.created_at.split('.')[0] if '.' in info.created_at else info.created_at }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewKnowledgeSections('{{ source_file }}')">
                                        <i class="bi bi-eye"></i> è©³ç´°
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteKnowledgeSource('{{ source_file }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ã¾ã ãƒŠãƒ¬ãƒƒã‚¸ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ãŠçŸ¥ã‚‰ã›ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="admin-section">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-megaphone"></i> ãŠçŸ¥ã‚‰ã›ç®¡ç†</h3>
                <button class="btn btn-gradient" onclick="openAnnouncementModal()">
                    <i class="bi bi-plus-lg"></i> æ–°è¦ãŠçŸ¥ã‚‰ã›
                </button>
            </div>
            
            <div id="announcementsList">
                <div class="text-center py-3" id="announcementsLoading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ãŠçŸ¥ã‚‰ã›ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="announcementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="announcementModalTitle">ãŠçŸ¥ã‚‰ã›ã‚’ä½œæˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="announcementId">
                    <div class="mb-3">
                        <label for="announcementTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                        <input type="text" class="form-control" id="announcementTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="announcementContent" class="form-label">å†…å®¹ *</label>
                        <textarea class="form-control" id="announcementContent" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="announcementType" class="form-label">é€šçŸ¥ã‚¿ã‚¤ãƒ—</label>
                        <select class="form-select" id="announcementType">
                            <option value="info">ğŸ“˜ ãŠçŸ¥ã‚‰ã› (info)</option>
                            <option value="warning">âš ï¸ æ³¨æ„ (warning)</option>
                            <option value="success">âœ… å®Œäº†/æˆåŠŸ (success)</option>
                        </select>
                    </div>
                    {% if current_role == 'super_admin' %}
                    <div class="mb-3">
                        <label for="announcementTarget" class="form-label">å¯¾è±¡</label>
                        <select class="form-select" id="announcementTarget">
                            <option value="all">å…¨ä½“é€šçŸ¥ï¼ˆã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</option>
                            {% for tenant in tenants %}
                            <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" id="announcementTarget" value="{{ session.tenant_id }}">
                    <div class="mb-3">
                        <label class="form-label">å¯¾è±¡</label>
                        <input type="text" class="form-control" value="è‡ªãƒ†ãƒŠãƒ³ãƒˆã®ã¿" disabled>
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="announcementPublishAt" class="form-label">å…¬é–‹æ—¥æ™‚</label>
                            <input type="datetime-local" class="form-control" id="announcementPublishAt">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="announcementExpiresAt" class="form-label">æœ‰åŠ¹æœŸé™</label>
                            <input type="datetime-local" class="form-control" id="announcementExpiresAt">
                            <small class="text-muted">ç©ºæ¬„ã®å ´åˆã€ç„¡æœŸé™</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveAnnouncement()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="videoTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" class="form-control" id="videoTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="videoDescription" class="form-label">èª¬æ˜</label>
                            <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="videoCategory" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                            <select class="form-select" id="videoCategory">
                                <option value="">æœªåˆ†é¡</option>
                                {% for category in categories if category.parent_id is none %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% for subcategory in categories if subcategory.parent_id == category.id %}
                                <option value="{{ subcategory.id }}">â”” {{ subcategory.name }}</option>
                                {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="videoFile" class="form-label">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« * (MP4, AVI, MOV, MKV, WebM)</label>
                            <input type="file" class="form-control" id="videoFile" accept="video/*" required>
                        </div>
                        <div class="progress mb-3" id="uploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="uploadVideo()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‹•ç”»ã‚’ç·¨é›†</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVideoId">
                    <div class="mb-3">
                        <label for="editVideoTitle" class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                        <input type="text" class="form-control" id="editVideoTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVideoDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="editVideoDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editVideoCategory" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select class="form-select" id="editVideoCategory">
                            <option value="">æœªåˆ†é¡</option>
                            {% for category in categories if category.parent_id is none %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% for subcategory in categories if subcategory.parent_id == category.id %}
                            <option value="{{ subcategory.id }}">â”” {{ subcategory.name }}</option>
                            {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="updateVideo()">æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–è´çµ±è¨ˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsModalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼å *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryParent" class="form-label">è¦ªã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select class="form-select" id="categoryParent">
                            <option value="">ãªã—ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰</option>
                            {% for category in categories if category.parent_id is none %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="categoryIcon" class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
                            <select class="form-select" id="categoryIcon" onchange="updateIconPreview()">
                                <option value="bi-folder">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼</option>
                                <option value="bi-book">ğŸ“š æœ¬</option>
                                <option value="bi-lightbulb">ğŸ’¡ é›»çƒ</option>
                                <option value="bi-briefcase">ğŸ’¼ ãƒ–ãƒªãƒ¼ãƒ•ã‚±ãƒ¼ã‚¹</option>
                                <option value="bi-chat-dots">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</option>
                                <option value="bi-gear">âš™ï¸ æ­¯è»Š</option>
                                <option value="bi-graph-up">ğŸ“ˆ ã‚°ãƒ©ãƒ•</option>
                                <option value="bi-bar-chart">ğŸ“Š æ£’ã‚°ãƒ©ãƒ•</option>
                                <option value="bi-collection">ğŸ“‘ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</option>
                                <option value="bi-people">ğŸ‘¥ äººã€…</option>
                                <option value="bi-rocket">ğŸš€ ãƒ­ã‚±ãƒƒãƒˆ</option>
                                <option value="bi-star">â­ æ˜Ÿ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="categoryColor" class="form-label">ã‚«ãƒ©ãƒ¼</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="categoryColor" value="#667eea">
                                <span id="categoryColorHex">#667eea</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="categoryOrder" class="form-label">è¡¨ç¤ºé †</label>
                        <input type="number" class="form-control" id="categoryOrder" value="0" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                        <div class="d-flex align-items-center p-3 border rounded">
                            <i id="iconPreview" class="bi-folder category-icon-preview" style="color: #667eea; font-size: 2rem;"></i>
                            <span id="namePreview" class="ms-2 fw-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼å</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveCategory()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¥­ç¨®ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="industryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="industryModalTitle">æ¥­ç¨®ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="industryId">
                    <div class="mb-3">
                        <label for="industryName" class="form-label">æ¥­ç¨®åï¼ˆæ—¥æœ¬èªï¼‰ *</label>
                        <input type="text" class="form-control" id="industryName" required placeholder="ä¾‹ï¼šå®¿æ³Š">
                    </div>
                    <div class="mb-3">
                        <label for="industryNameEn" class="form-label">æ¥­ç¨®åï¼ˆè‹±èªï¼‰</label>
                        <input type="text" class="form-control" id="industryNameEn" placeholder="ä¾‹ï¼šAccommodation">
                    </div>
                    <div class="mb-3">
                        <label for="industryDescription" class="form-label">èª¬æ˜</label>
                        <textarea class="form-control" id="industryDescription" rows="2" placeholder="ä¾‹ï¼šå®¿æ³Šæ¥­ãƒ»ãƒ›ãƒ†ãƒ«ãƒ»æ—…é¤¨"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="industryIcon" class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
                            <select class="form-select" id="industryIcon">
                                <option value="bi-building">ğŸ¢ ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°</option>
                                <option value="bi-house-door">ğŸ  ä½å®…</option>
                                <option value="bi-shop">ğŸª ã‚·ãƒ§ãƒƒãƒ—</option>
                                <option value="bi-cup-hot">â˜• é£²é£Ÿ</option>
                                <option value="bi-heart-pulse">ğŸ’— ä»‹è­·</option>
                                <option value="bi-hospital">ğŸ¥ åŒ»ç™‚</option>
                                <option value="bi-mortarboard">ğŸ“ æ•™è‚²</option>
                                <option value="bi-truck">ğŸšš ç‰©æµ</option>
                                <option value="bi-gear">âš™ï¸ è£½é€ </option>
                                <option value="bi-laptop">ğŸ’» IT</option>
                                <option value="bi-bank">ğŸ¦ é‡‘è</option>
                                <option value="bi-cart">ğŸ›’ EC</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="industryColor" class="form-label">ã‚«ãƒ©ãƒ¼</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="industryColor" value="#667eea">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveIndustry()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="accessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock"></i> ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®š</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="accessCategoryId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼: <span id="accessCategoryName"></span></label>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">
                            <i class="bi bi-info-circle"></i> 
                            æ¥­ç¨®ã‚’é¸æŠã—ãªã„å ´åˆã¯ã€Œå…¨æ¥­ç¨®å…¬é–‹ã€ã¨ãªã‚Šã¾ã™ã€‚
                            é¸æŠã—ãŸæ¥­ç¨®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹æ¥­ç¨®</label>
                        <div id="accessIndustryList" class="access-checkbox-group">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <div id="accessPreview" class="p-3 border rounded">
                            <span class="access-badge access-public"><i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveAccessControl()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle"><i class="bi bi-person-plus"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="userUsername" class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å *</label>
                        <input type="text" class="form-control" id="userUsername" required placeholder="ä¾‹ï¼štanaka_hotel">
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" class="form-control" id="userEmail" required placeholder="ä¾‹ï¼štanaka@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span id="passwordRequiredMark">*</span></label>
                        <input type="password" class="form-control" id="userPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                        <small class="text-muted" id="passwordHint" style="display: none;">ç©ºæ¬„ã®å ´åˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“</small>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">ãƒ­ãƒ¼ãƒ«</label>
                        <select class="form-select" id="userRole">
                            <option value="user">userï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</option>
                            <option value="company_admin">company_adminï¼ˆä¼šç¤¾ç®¡ç†è€…ï¼‰</option>
                            {% if current_role == 'super_admin' %}
                            <option value="super_admin">super_adminï¼ˆæ¥½å¤©ç®¡ç†è€…ï¼‰</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3" id="userTenantGroup">
                        <label for="userTenant" class="form-label">ãƒ†ãƒŠãƒ³ãƒˆ</label>
                        <select class="form-select" id="userTenant" onchange="loadDepartmentsForTenant(this.value)">
                            <option value="">ãªã—</option>
                            {% for tenant in tenants %}
                            <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="userDepartmentGroup">
                        <label for="userDepartment" class="form-label">éƒ¨ç½²</label>
                        <select class="form-select" id="userDepartment">
                            <option value="">ãªã—</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userIndustry" class="form-label">æ¥­ç¨®</label>
                        <select class="form-select" id="userIndustry">
                            <option value="">ãªã—ï¼ˆç®¡ç†è€…å‘ã‘ï¼‰</option>
                            {% for industry in industries %}
                            <option value="{{ industry.id }}">{{ industry.name }} ({{ industry.name_en }})</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">æ¥­ç¨®ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ¥­ç¨®å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</small>
                    </div>
                    <div class="mb-3">
                        <label for="userCompany" class="form-label">ä¼šç¤¾å</label>
                        <input type="text" class="form-control" id="userCompany" placeholder="ä¾‹ï¼šã‚°ãƒ©ãƒ³ãƒ‰ãƒ›ãƒ†ãƒ«æ±äº¬">
                    </div>
                    <div class="mb-3 form-check" style="display:none;">
                        <input type="checkbox" class="form-check-input" id="userIsAdmin">
                        <label class="form-check-label" for="userIsAdmin">ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ï¼ˆæ—§ãƒ•ãƒ©ã‚°ï¼‰</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveUser()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="tenantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tenantModalTitle"><i class="bi bi-buildings"></i> ãƒ†ãƒŠãƒ³ãƒˆã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="tenantId">
                    <div class="mb-3">
                        <label for="tenantName" class="form-label">ãƒ†ãƒŠãƒ³ãƒˆå *</label>
                        <input type="text" class="form-control" id="tenantName" required placeholder="ä¾‹ï¼šã‚°ãƒ©ãƒ³ãƒ‰ãƒ›ãƒ†ãƒ«æ±äº¬">
                    </div>
                    <div class="mb-3">
                        <label for="tenantIndustry" class="form-label">æ¥­ç¨®</label>
                        <select class="form-select" id="tenantIndustry">
                            <option value="">ãªã—</option>
                            {% for industry in industries %}
                            <option value="{{ industry.id }}">{{ industry.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveTenant()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨ç½²ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="departmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departmentModalTitle"><i class="bi bi-diagram-3"></i> éƒ¨ç½²ã‚’è¿½åŠ </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="departmentId">
                    <div class="mb-3">
                        <label for="departmentName" class="form-label">éƒ¨ç½²å *</label>
                        <input type="text" class="form-control" id="departmentName" required placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨">
                    </div>
                    <div class="mb-3">
                        <label for="departmentTenant" class="form-label">ãƒ†ãƒŠãƒ³ãƒˆ *</label>
                        <select class="form-select" id="departmentTenant" required>
                            <option value="">ãƒ†ãƒŠãƒ³ãƒˆã‚’é¸æŠ...</option>
                            {% for tenant in tenants %}
                            <option value="{{ tenant.id }}">{{ tenant.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="saveDepartment()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="knowledgeUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> å¤–éƒ¨ãƒŠãƒ¬ãƒƒã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="knowledgeUploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="knowledgeIndustry" class="form-label">å¯¾è±¡æ¥­ç¨® *</label>
                            <select class="form-select" id="knowledgeIndustry" required>
                                <option value="">æ¥­ç¨®ã‚’é¸æŠ...</option>
                                {% for industry in industries %}
                                {% if current_role == 'super_admin' or session.get('industry_id') == industry.id %}
                                <option value="{{ industry.id }}" {% if current_role != 'super_admin' %}selected{% endif %}>{{ industry.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> 
                                é¸æŠã—ãŸæ¥­ç¨®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã«è³ªå•ã—ãŸéš›ã€ã“ã®ãƒŠãƒ¬ãƒƒã‚¸ãŒå‚ç…§ã•ã‚Œã¾ã™ã€‚
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="knowledgeFile" class="form-label">Markdownãƒ•ã‚¡ã‚¤ãƒ« * (.md)</label>
                            <input type="file" class="form-control" id="knowledgeFile" accept=".md" required>
                            <div class="form-text">
                                <i class="bi bi-lightbulb"></i> 
                                ãƒ•ã‚¡ã‚¤ãƒ«ã¯ ## ã‚„ ### ã®è¦‹å‡ºã—ã”ã¨ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²ã•ã‚Œã¾ã™ã€‚
                            </div>
                        </div>
                        <div class="progress mb-3" id="knowledgeUploadProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-gradient" onclick="uploadKnowledge()">
                        <i class="bi bi-cloud-upload"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="knowledgeSectionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-book"></i> ãƒŠãƒ¬ãƒƒã‚¸è©³ç´°: <span id="knowledgeSourceName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="knowledgeSectionsBody">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ–‡å­—èµ·ã“ã—é–‹å§‹
        async function startTranscription(videoId) {
            if (!confirm('æ–‡å­—èµ·ã“ã—ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿå‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const statusSpan = document.getElementById(`transcription-status-${videoId}`);
            const btn = document.getElementById(`transcribe-btn-${videoId}`);
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            btn.disabled = true;
            statusSpan.innerHTML = '<span class="badge bg-info"><i class="bi bi-clock"></i> å¾…æ©Ÿä¸­</span>';
            
            try {
                const response = await fetch(`/api/admin/videos/${videoId}/transcribe`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusSpan.innerHTML = '<span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>';
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
                    pollTranscriptionStatus(videoId);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    statusSpan.innerHTML = '<span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>';
                    btn.disabled = false;
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
                statusSpan.innerHTML = '<span class="badge bg-secondary">æœªå®Ÿè¡Œ</span>';
                btn.disabled = false;
            }
        }
        
        // æ–‡å­—èµ·ã“ã—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
        function pollTranscriptionStatus(videoId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/admin/videos/${videoId}/transcript-status`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const statusSpan = document.getElementById(`transcription-status-${videoId}`);
                        const btn = document.getElementById(`transcribe-btn-${videoId}`);
                        
                        if (data.status === 'completed') {
                            statusSpan.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> å®Œäº†</span>';
                            btn.disabled = false;
                            clearInterval(interval);
                        } else if (data.status === 'failed') {
                            statusSpan.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> å¤±æ•—</span>';
                            btn.disabled = false;
                            clearInterval(interval);
                        } else if (data.status === 'processing') {
                            statusSpan.innerHTML = '<span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> å‡¦ç†ä¸­</span>';
                        }
                    }
                } catch (error) {
                    console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 5000); // 5ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        }
        
        // å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadVideo() {
            const title = document.getElementById('videoTitle').value;
            const description = document.getElementById('videoDescription').value;
            const categoryId = document.getElementById('videoCategory').value;
            const file = document.getElementById('videoFile').files[0];
            
            if (!title || !file) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…é ˆã§ã™');
                return;
            }
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('category_id', categoryId);
            formData.append('video', file);
            
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // å‹•ç”»ç·¨é›†
        function editVideo(id, title, description, categoryId) {
            document.getElementById('editVideoId').value = id;
            document.getElementById('editVideoTitle').value = title;
            document.getElementById('editVideoDescription').value = description;
            document.getElementById('editVideoCategory').value = categoryId || '';
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function updateVideo() {
            const id = document.getElementById('editVideoId').value;
            const title = document.getElementById('editVideoTitle').value;
            const description = document.getElementById('editVideoDescription').value;
            const categoryId = document.getElementById('editVideoCategory').value;
            
            try {
                // å‹•ç”»æƒ…å ±ã‚’æ›´æ–°
                const response = await fetch(`/api/admin/update/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°
                await fetch(`/api/admin/videos/${id}/category`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category_id: categoryId ? parseInt(categoryId) : null })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®æ›´æ–°ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // å‹•ç”»å‰Šé™¤
        async function deleteVideo(id, title) {
            if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/delete/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('å‹•ç”»ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–è´çµ±è¨ˆï¼ˆæ‹¡å¼µç‰ˆï¼‰
        async function viewUserStats(userId, username) {
            document.getElementById('statsModalTitle').textContent = `${username} ã®è¦–è´çµ±è¨ˆ`;
            const modalBody = document.getElementById('statsModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
            
            try {
                const response = await fetch(`/api/admin/user-stats-detail/${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                const s = data.summary;
                let html = `
                    <div class="row mb-3">
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-primary">${s.total_videos}</div>
                            <small class="text-muted">å…¨å‹•ç”»æ•°</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-success">${s.completed_videos}</div>
                            <small class="text-muted">å®Œäº†æ•°</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-info">${s.completion_rate}%</div>
                            <small class="text-muted">å®Œäº†ç‡</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-warning">${s.total_watch_time_display}</div>
                            <small class="text-muted">ç´¯è¨ˆè¦–è´æ™‚é–“</small>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: ${s.avg_progress}%"></div>
                    </div>
                    <small class="text-muted">å…¨ä½“å¹³å‡é€²æ—: ${s.avg_progress}%</small>
                `;
                
                html += '<div class="table-responsive mt-3"><table class="table table-striped table-sm">';
                html += '<thead><tr><th>å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</th><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>é€²æ—</th><th>æœ€çµ‚è¦–è´æ—¥</th></tr></thead><tbody>';
                
                data.details.forEach(stat => {
                    const progress = stat.progress_percent || 0;
                    const statusBadge = progress >= 90 ? 
                        '<span class="badge bg-success">å®Œäº†</span>' :
                        progress > 0 ? 
                        '<span class="badge bg-warning">è¦–è´ä¸­</span>' :
                        '<span class="badge bg-secondary">æœªè¦–è´</span>';
                    
                    html += `<tr>
                        <td>${stat.title}</td>
                        <td><small>${stat.category_name || '-'}</small></td>
                        <td>
                            ${statusBadge}
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${Math.round(progress)}%</small>
                        </td>
                        <td><small>${stat.updated_at ? stat.updated_at.split('.')[0] : '-'}</small></td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = '<div class="alert alert-danger">çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ========== ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç† ==========

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCategoryModal(id = null, name = '', description = '', icon = 'bi-folder', color = '#667eea', parentId = null, displayOrder = 0) {
            document.getElementById('categoryId').value = id || '';
            document.getElementById('categoryName').value = name;
            document.getElementById('categoryDescription').value = description;
            document.getElementById('categoryIcon').value = icon;
            document.getElementById('categoryColor').value = color;
            document.getElementById('categoryColorHex').textContent = color;
            document.getElementById('categoryParent').value = parentId || '';
            document.getElementById('categoryOrder').value = displayOrder;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            updateIconPreview();
            document.getElementById('namePreview').textContent = name || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            document.getElementById('categoryModalTitle').textContent = id ? 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç·¨é›†' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ ';
            
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        }

        // ã‚¢ã‚¤ã‚³ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateIconPreview() {
            const icon = document.getElementById('categoryIcon').value;
            const color = document.getElementById('categoryColor').value;
            document.getElementById('iconPreview').className = icon + ' category-icon-preview';
            document.getElementById('iconPreview').style.color = color;
            document.getElementById('categoryColorHex').textContent = color;
        }

        // ã‚«ãƒ©ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
        document.getElementById('categoryColor').addEventListener('input', updateIconPreview);
        document.getElementById('categoryName').addEventListener('input', function() {
            document.getElementById('namePreview').textContent = this.value || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å';
        });

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¿å­˜
        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value;
            const description = document.getElementById('categoryDescription').value;
            const icon = document.getElementById('categoryIcon').value;
            const color = document.getElementById('categoryColor').value;
            const parentId = document.getElementById('categoryParent').value;
            const displayOrder = parseInt(document.getElementById('categoryOrder').value) || 0;
            
            if (!name) {
                alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼åã¯å¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                name,
                description,
                icon,
                color,
                parent_id: parentId ? parseInt(parentId) : null,
                display_order: displayOrder
            };
            
            try {
                const url = id ? `/api/admin/categories/${id}` : '/api/admin/categories';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤
        async function deleteCategory(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ç´ä»˜ã„ã¦ã„ã‚‹å‹•ç”»ã¯ã€Œæœªåˆ†é¡ã€ã«ãªã‚Šã¾ã™ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/categories/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ========== æ¥­ç¨®ç®¡ç† ==========

        // æ¥­ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let industriesCache = [];

        // æ¥­ç¨®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadIndustries() {
            try {
                const response = await fetch('/api/industries');
                industriesCache = await response.json();
                return industriesCache;
            } catch (error) {
                console.error('æ¥­ç¨®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return [];
            }
        }

        // æ¥­ç¨®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openIndustryModal(id = null, name = '', nameEn = '', description = '', icon = 'bi-building', color = '#667eea') {
            document.getElementById('industryId').value = id || '';
            document.getElementById('industryName').value = name;
            document.getElementById('industryNameEn').value = nameEn;
            document.getElementById('industryDescription').value = description;
            document.getElementById('industryIcon').value = icon;
            document.getElementById('industryColor').value = color;
            
            document.getElementById('industryModalTitle').textContent = id ? 'æ¥­ç¨®ã‚’ç·¨é›†' : 'æ¥­ç¨®ã‚’è¿½åŠ ';
        }

        // æ¥­ç¨®ã‚’ä¿å­˜
        async function saveIndustry() {
            const id = document.getElementById('industryId').value;
            const name = document.getElementById('industryName').value;
            const nameEn = document.getElementById('industryNameEn').value;
            const description = document.getElementById('industryDescription').value;
            const icon = document.getElementById('industryIcon').value;
            const color = document.getElementById('industryColor').value;
            
            if (!name) {
                alert('æ¥­ç¨®åã¯å¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                name,
                name_en: nameEn,
                description,
                icon,
                color
            };
            
            try {
                const url = id ? `/api/admin/industries/${id}` : '/api/admin/industries';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'æ¥­ç¨®ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'æ¥­ç¨®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // æ¥­ç¨®ã‚’å‰Šé™¤
        async function deleteIndustry(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®æ¥­ç¨®ã«æ‰€å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/industries/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('æ¥­ç¨®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ========== ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç† ==========

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠã•ã‚Œã¦ã„ã‚‹æ¥­ç¨®ID
        let selectedIndustryIds = [];

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openAccessModal(categoryId, categoryName) {
            document.getElementById('accessCategoryId').value = categoryId;
            document.getElementById('accessCategoryName').textContent = categoryName;
            
            // æ¥­ç¨®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if (industriesCache.length === 0) {
                await loadIndustries();
            }
            
            // ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã‚’å–å¾—
            try {
                const response = await fetch(`/api/admin/categories/${categoryId}/access`);
                const accessData = await response.json();
                selectedIndustryIds = accessData.industry_ids || [];
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                selectedIndustryIds = [];
            }
            
            // æ¥­ç¨®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            const container = document.getElementById('accessIndustryList');
            container.innerHTML = '';
            
            industriesCache.forEach(industry => {
                const isSelected = selectedIndustryIds.includes(industry.id);
                const item = document.createElement('div');
                item.className = 'access-checkbox-item' + (isSelected ? ' selected' : '');
                item.dataset.industryId = industry.id;
                item.innerHTML = `
                    <i class="${industry.icon}" style="color: ${industry.color}"></i>
                    <span>${industry.name}</span>
                `;
                item.onclick = function() {
                    toggleIndustrySelection(industry.id, this);
                };
                container.appendChild(item);
            });
            
            updateAccessPreview();
            
            new bootstrap.Modal(document.getElementById('accessModal')).show();
        }

        // æ¥­ç¨®é¸æŠã®ãƒˆã‚°ãƒ«
        function toggleIndustrySelection(industryId, element) {
            const index = selectedIndustryIds.indexOf(industryId);
            if (index === -1) {
                selectedIndustryIds.push(industryId);
                element.classList.add('selected');
            } else {
                selectedIndustryIds.splice(index, 1);
                element.classList.remove('selected');
            }
            updateAccessPreview();
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateAccessPreview() {
            const previewContainer = document.getElementById('accessPreview');
            
            if (selectedIndustryIds.length === 0) {
                previewContainer.innerHTML = '<span class="access-badge access-public"><i class="bi bi-globe"></i> å…¨æ¥­ç¨®å…¬é–‹</span>';
            } else {
                const selectedIndustries = industriesCache.filter(i => selectedIndustryIds.includes(i.id));
                let html = '<span class="access-badge access-restricted"><i class="bi bi-lock"></i> åˆ¶é™ã‚ã‚Š</span> ';
                html += selectedIndustries.map(i => `<span class="access-badge">${i.name}</span>`).join(' ');
                previewContainer.innerHTML = html;
            }
        }

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¿å­˜
        async function saveAccessControl() {
            const categoryId = document.getElementById('accessCategoryId').value;
            
            try {
                const response = await fetch(`/api/admin/categories/${categoryId}/access`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        industry_ids: selectedIndustryIds
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ¥­ç¨®ã‚’èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', function() {
            loadIndustries();
        });

        // ========== ãƒ†ãƒŠãƒ³ãƒˆç®¡ç† ==========

        function openTenantModal(id = null, name = '', industryId = null) {
            document.getElementById('tenantId').value = id || '';
            document.getElementById('tenantName').value = name;
            document.getElementById('tenantIndustry').value = industryId || '';
            document.getElementById('tenantModalTitle').textContent = id ? 'ãƒ†ãƒŠãƒ³ãƒˆã‚’ç·¨é›†' : 'ãƒ†ãƒŠãƒ³ãƒˆã‚’è¿½åŠ ';
            new bootstrap.Modal(document.getElementById('tenantModal')).show();
        }

        async function saveTenant() {
            const id = document.getElementById('tenantId').value;
            const name = document.getElementById('tenantName').value;
            const industryId = document.getElementById('tenantIndustry').value;
            
            if (!name) { alert('ãƒ†ãƒŠãƒ³ãƒˆåã¯å¿…é ˆã§ã™'); return; }
            
            const url = id ? `/api/admin/tenants/${id}` : '/api/admin/tenants';
            const method = id ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, industry_id: industryId ? parseInt(industryId) : null })
                });
                const result = await response.json();
                if (response.ok) { alert(result.message); location.reload(); }
                else { alert('ã‚¨ãƒ©ãƒ¼: ' + result.error); }
            } catch (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error); }
        }

        async function deleteTenant(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/admin/tenants/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok) { alert(data.message); location.reload(); }
                else { alert('ã‚¨ãƒ©ãƒ¼: ' + data.error); }
            } catch (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error); }
        }

        // ========== éƒ¨ç½²ç®¡ç† ==========

        function openDepartmentModal(id = null, name = '', tenantId = null) {
            document.getElementById('departmentId').value = id || '';
            document.getElementById('departmentName').value = name;
            document.getElementById('departmentTenant').value = tenantId || '';
            document.getElementById('departmentModalTitle').textContent = id ? 'éƒ¨ç½²ã‚’ç·¨é›†' : 'éƒ¨ç½²ã‚’è¿½åŠ ';
            new bootstrap.Modal(document.getElementById('departmentModal')).show();
        }

        async function saveDepartment() {
            const id = document.getElementById('departmentId').value;
            const name = document.getElementById('departmentName').value;
            const tenantId = document.getElementById('departmentTenant').value;
            
            if (!name) { alert('éƒ¨ç½²åã¯å¿…é ˆã§ã™'); return; }
            if (!tenantId) { alert('ãƒ†ãƒŠãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            
            const url = id ? `/api/admin/departments/${id}` : '/api/admin/departments';
            const method = id ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, tenant_id: parseInt(tenantId) })
                });
                const result = await response.json();
                if (response.ok) { alert(result.message); location.reload(); }
                else { alert('ã‚¨ãƒ©ãƒ¼: ' + result.error); }
            } catch (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error); }
        }

        async function deleteDepartment(id, name) {
            if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            try {
                const response = await fetch(`/api/admin/departments/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok) { alert(data.message); location.reload(); }
                else { alert('ã‚¨ãƒ©ãƒ¼: ' + data.error); }
            } catch (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error); }
        }

        // ãƒ†ãƒŠãƒ³ãƒˆé¸æŠæ™‚ã«éƒ¨ç½²ãƒªã‚¹ãƒˆã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰
        async function loadDepartmentsForTenant(tenantId) {
            const select = document.getElementById('userDepartment');
            select.innerHTML = '<option value="">ãªã—</option>';
            if (!tenantId) return;
            
            try {
                const response = await fetch(`/api/admin/departments?tenant_id=${tenantId}`);
                const departments = await response.json();
                departments.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = d.name;
                    select.appendChild(option);
                });
            } catch (error) { console.error('éƒ¨ç½²ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error); }
        }

        // ========== CSVä¸€æ‹¬ç™»éŒ² ==========
        
        async function importCSV(input) {
            if (!input.files[0]) return;
            
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            try {
                const response = await fetch('/api/admin/users/import-csv', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok) {
                    let msg = result.message;
                    if (result.errors && result.errors.length > 0) {
                        msg += '\n\nã‚¨ãƒ©ãƒ¼:\n' + result.errors.join('\n');
                    }
                    alert(msg);
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error);
            }
            input.value = ''; // ãƒªã‚»ãƒƒãƒˆ
        }

        // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ==========

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openUserModal(id = null) {
            document.getElementById('userId').value = id || '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userTenant').value = '';
            document.getElementById('userDepartment').innerHTML = '<option value="">ãªã—</option>';
            document.getElementById('userIndustry').value = '';
            document.getElementById('userCompany').value = '';
            document.getElementById('userIsAdmin').checked = false;
            
            // æ–°è¦ä½œæˆæ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ
            if (id) {
                document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-gear"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†';
                document.getElementById('passwordRequiredMark').style.display = 'none';
                document.getElementById('passwordHint').style.display = 'block';
                document.getElementById('userPassword').removeAttribute('required');
            } else {
                document.getElementById('userModalTitle').innerHTML = '<i class="bi bi-person-plus"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ';
                document.getElementById('passwordRequiredMark').style.display = 'inline';
                document.getElementById('passwordHint').style.display = 'none';
                document.getElementById('userPassword').setAttribute('required', 'required');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
        async function editUser(userId) {
            openUserModal(userId);
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                const user = await response.json();
                
                if (response.ok) {
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userRole').value = user.role || 'user';
                    document.getElementById('userTenant').value = user.tenant_id || '';
                    document.getElementById('userIndustry').value = user.industry_id || '';
                    document.getElementById('userCompany').value = user.company_name || '';
                    document.getElementById('userIsAdmin').checked = user.is_admin;
                    
                    // ãƒ†ãƒŠãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€éƒ¨ç½²ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
                    if (user.tenant_id) {
                        await loadDepartmentsForTenant(user.tenant_id);
                        document.getElementById('userDepartment').value = user.department_id || '';
                    }
                    
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + user.error);
                }
            } catch (error) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜
        async function saveUser() {
            const id = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const tenantId = document.getElementById('userTenant').value;
            const departmentId = document.getElementById('userDepartment').value;
            const industryId = document.getElementById('userIndustry').value;
            const companyName = document.getElementById('userCompany').value;
            
            if (!username || !email) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                return;
            }
            
            if (!id && !password) {
                alert('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…é ˆã§ã™');
                return;
            }
            
            const data = {
                username,
                email,
                role,
                tenant_id: tenantId ? parseInt(tenantId) : null,
                department_id: departmentId ? parseInt(departmentId) : null,
                industry_id: industryId ? parseInt(industryId) : null,
                company_name: companyName,
                is_admin: role === 'super_admin'
            };
            
            if (password) {
                data.password = password;
            }
            
            try {
                const url = id ? `/api/admin/users/${id}` : '/api/admin/users';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(id ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        async function deleteUser(userId, username) {
            if (!confirm(`ã€Œ${username}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦–è´å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            }
        }

        // ========== å¤–éƒ¨ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç† ==========
        
        // ãƒŠãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadKnowledge() {
            const industryId = document.getElementById('knowledgeIndustry').value;
            const file = document.getElementById('knowledgeFile').files[0];
            
            if (!industryId) {
                alert('æ¥­ç¨®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!file.name.endsWith('.md')) {
                alert('Markdownãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.mdï¼‰ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('industry_id', industryId);
            
            document.getElementById('knowledgeUploadProgress').style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/knowledge/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                document.getElementById('knowledgeUploadProgress').style.display = 'none';
                
                if (response.ok) {
                    alert(`âœ… ${result.message}\n\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.filename}\nã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${result.sections}`);
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                document.getElementById('knowledgeUploadProgress').style.display = 'none';
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }
        
        // ãƒŠãƒ¬ãƒƒã‚¸ã‚½ãƒ¼ã‚¹å‰Šé™¤
        async function deleteKnowledgeSource(sourceFile) {
            if (!confirm(`ã€Œ${sourceFile}ã€ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/knowledge/delete-by-source', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source_file: sourceFile })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('ãƒŠãƒ¬ãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }
        
        // ãƒŠãƒ¬ãƒƒã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°ã‚’è¡¨ç¤º
        async function viewKnowledgeSections(sourceFile) {
            document.getElementById('knowledgeSourceName').textContent = sourceFile;
            const body = document.getElementById('knowledgeSectionsBody');
            body.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>';
            
            new bootstrap.Modal(document.getElementById('knowledgeSectionsModal')).show();
            
            try {
                const response = await fetch('/api/admin/knowledge');
                const allKnowledge = await response.json();
                
                // æŒ‡å®šã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒŠãƒ¬ãƒƒã‚¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const sections = allKnowledge.filter(k => k.source_file === sourceFile);
                
                if (sections.length === 0) {
                    body.innerHTML = '<div class="alert alert-info">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                
                let html = '<div class="list-group">';
                for (const section of sections) {
                    const preview = section.preview ? section.preview + '...' : '';
                    const keywords = section.keywords ? section.keywords.split(',').map(k => 
                        `<span class="badge bg-light text-dark me-1">${k.trim()}</span>`
                    ).join('') : '';
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1"><i class="bi bi-bookmark text-primary"></i> ${section.title}</h6>
                                    <p class="mb-1 text-muted small">${preview}</p>
                                    <div class="mt-1">${keywords}</div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-2" 
                                        onclick="deleteKnowledgeSection(${section.id}, '${section.title.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                body.innerHTML = html;
            } catch (error) {
                body.innerHTML = '<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
            }
        }
        
        // å€‹åˆ¥ãƒŠãƒ¬ãƒƒã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
        async function deleteKnowledgeSection(id, title) {
            if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/knowledge/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }

        // ========== ãŠçŸ¥ã‚‰ã›ç®¡ç† ==========
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãŠçŸ¥ã‚‰ã›ä¸€è¦§ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', loadAnnouncements);
        
        async function loadAnnouncements() {
            try {
                const response = await fetch('/api/admin/announcements');
                const data = await response.json();
                
                const container = document.getElementById('announcementsList');
                const loading = document.getElementById('announcementsLoading');
                if (loading) loading.style.display = 'none';
                
                if (data.success && data.announcements.length > 0) {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ã‚¿ã‚¤ãƒ—</th>
                                        <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                        <th>å¯¾è±¡</th>
                                        <th>çŠ¶æ…‹</th>
                                        <th>å…¬é–‹æ—¥</th>
                                        <th>æœ‰åŠ¹æœŸé™</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    const typeIcons = { 'info': 'ğŸ“˜', 'warning': 'âš ï¸', 'success': 'âœ…' };
                    
                    data.announcements.forEach(a => {
                        const typeIcon = typeIcons[a.type] || 'ğŸ“˜';
                        const target = a.target_tenant_id ? a.tenant_name : '<span class="badge bg-primary">å…¨ä½“</span>';
                        const status = a.is_active 
                            ? '<span class="badge bg-success">æœ‰åŠ¹</span>' 
                            : '<span class="badge bg-secondary">ç„¡åŠ¹</span>';
                        const publishAt = a.publish_at ? a.publish_at.replace('T', ' ').substring(0, 16) : '-';
                        const expiresAt = a.expires_at ? a.expires_at.replace('T', ' ').substring(0, 16) : 'ç„¡æœŸé™';
                        
                        html += `
                            <tr>
                                <td>${typeIcon}</td>
                                <td><strong>${escapeHtmlAdmin(a.title)}</strong><br><small class="text-muted">${escapeHtmlAdmin(a.content).substring(0, 50)}${a.content.length > 50 ? '...' : ''}</small></td>
                                <td>${target}</td>
                                <td>${status}</td>
                                <td><small>${publishAt}</small></td>
                                <td><small>${expiresAt}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editAnnouncement(${a.id}, '${escapeAttr(a.title)}', '${escapeAttr(a.content)}', '${a.type}', '${a.target_tenant_id || 'all'}', '${a.publish_at || ''}', '${a.expires_at || ''}', ${a.is_active})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-${a.is_active ? 'warning' : 'success'}" onclick="toggleAnnouncement(${a.id}, ${!a.is_active})">
                                        <i class="bi bi-${a.is_active ? 'pause' : 'play'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${a.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> ã¾ã ãŠçŸ¥ã‚‰ã›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°è¦ãŠçŸ¥ã‚‰ã›ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚
                        </div>`;
                }
            } catch (error) {
                console.error('ãŠçŸ¥ã‚‰ã›èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('announcementsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
                    </div>`;
            }
        }
        
        function escapeHtmlAdmin(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeAttr(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n');
        }
        
        function openAnnouncementModal() {
            document.getElementById('announcementId').value = '';
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementType').value = 'info';
            document.getElementById('announcementPublishAt').value = '';
            document.getElementById('announcementExpiresAt').value = '';
            const targetEl = document.getElementById('announcementTarget');
            if (targetEl && targetEl.tagName === 'SELECT') targetEl.value = 'all';
            document.getElementById('announcementModalTitle').textContent = 'ãŠçŸ¥ã‚‰ã›ã‚’ä½œæˆ';
            new bootstrap.Modal(document.getElementById('announcementModal')).show();
        }
        
        function editAnnouncement(id, title, content, type, targetTenantId, publishAt, expiresAt, isActive) {
            document.getElementById('announcementId').value = id;
            document.getElementById('announcementTitle').value = title.replace(/\\n/g, '\n');
            document.getElementById('announcementContent').value = content.replace(/\\n/g, '\n');
            document.getElementById('announcementType').value = type;
            const targetEl = document.getElementById('announcementTarget');
            if (targetEl && targetEl.tagName === 'SELECT') targetEl.value = targetTenantId;
            
            if (publishAt) {
                document.getElementById('announcementPublishAt').value = publishAt.substring(0, 16);
            }
            if (expiresAt) {
                document.getElementById('announcementExpiresAt').value = expiresAt.substring(0, 16);
            }
            
            document.getElementById('announcementModalTitle').textContent = 'ãŠçŸ¥ã‚‰ã›ã‚’ç·¨é›†';
            new bootstrap.Modal(document.getElementById('announcementModal')).show();
        }
        
        async function saveAnnouncement() {
            const id = document.getElementById('announcementId').value;
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const type = document.getElementById('announcementType').value;
            const targetTenantId = document.getElementById('announcementTarget').value;
            const publishAt = document.getElementById('announcementPublishAt').value;
            const expiresAt = document.getElementById('announcementExpiresAt').value;
            
            if (!title || !content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯å¿…é ˆã§ã™');
                return;
            }
            
            const body = {
                title, content, type,
                target_tenant_id: targetTenantId === 'all' ? null : parseInt(targetTenantId),
                publish_at: publishAt || null,
                expires_at: expiresAt || null
            };
            
            try {
                const url = id ? `/api/admin/announcements/${id}` : '/api/admin/announcements';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('announcementModal')).hide();
                    loadAnnouncements();
                    alert(data.message);
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }
        
        async function toggleAnnouncement(id, newStatus) {
            try {
                const response = await fetch(`/api/admin/announcements/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                const data = await response.json();
                
                if (data.success) {
                    loadAnnouncements();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }
        
        async function deleteAnnouncement(id) {
            if (!confirm('ã“ã®ãŠçŸ¥ã‚‰ã›ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/announcements/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadAnnouncements();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error);
            }
        }
    </script>
</body>
</html>
