<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー視聴状況 - LMS</title>
    {% include 'ga4_tracking.html' %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body { background-color: #f8f9fa; }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .stat-card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-card .stat-label { color: #6c757d; font-size: 0.85rem; }
        .table-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .progress-cell {
            min-width: 100px;
        }
        .progress-cell .progress {
            height: 8px;
            border-radius: 4px;
        }
        .badge-complete { background-color: #2a9d8f; color: white; }
        .badge-in-progress { background-color: #f4a261; color: white; }
        .badge-not-started { background-color: #e9ecef; color: #6c757d; }
        .status-icon-complete { color: #2a9d8f; }
        .status-icon-in-progress { color: #f4a261; }
        .status-icon-not-started { color: #dee2e6; }
        .user-detail-row { cursor: pointer; }
        .user-detail-row:hover { background-color: #f0f4ff !important; }
        .video-mini-progress {
            display: inline-block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            position: relative;
            background: #f0f0f0;
            margin: 2px;
            cursor: pointer;
        }
        .video-mini-progress .tooltip-inner { max-width: 250px; }
        .filter-toolbar {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .export-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
        }
        .export-btn:hover { opacity: 0.9; color: white; }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/courses">
                <i class="bi bi-mortarboard-fill"></i> Rakuten AI for Business トレーニング
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> {{ session.username }}
                    {% if session.industry_name %}
                    <small class="ms-1 opacity-75">[{{ session.industry_name }}]</small>
                    {% endif %}
                    {% if session.company_name %}
                    <small class="ms-1 opacity-75">{{ session.company_name }}</small>
                    {% endif %}
                </span>
                <a href="/admin/video-analytics" class="nav-link text-white me-2">
                    <i class="bi bi-bar-chart me-1"></i>全体分析
                </a>
                <a href="/admin/user-progress" class="nav-link text-white me-2 fw-bold">
                    <i class="bi bi-people-fill me-1"></i>ユーザー視聴状況
                </a>
                <a href="/admin" class="nav-link text-white me-2">
                    <i class="bi bi-gear me-1"></i>管理画面
                </a>
                <a href="/courses" class="nav-link text-white me-2">
                    <i class="bi bi-grid me-1"></i>コース
                </a>
                <a href="/my-progress" class="nav-link text-white me-2">
                    <i class="bi bi-graph-up-arrow me-1"></i>マイ視聴状況
                </a>
                <a href="/logout" class="nav-link text-white">
                    <i class="bi bi-box-arrow-right me-1"></i>ログアウト
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-people-fill me-2"></i>ユーザー視聴状況ダッシュボード</h2>
        </div>

        <!-- サマリーカード -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-primary" id="totalUsers">-</div>
                        <div class="stat-label"><i class="bi bi-people me-1"></i>登録ユーザー数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-success" id="activeUsers">-</div>
                        <div class="stat-label"><i class="bi bi-person-check me-1"></i>視聴開始済み</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-info" id="avgCompletion">-</div>
                        <div class="stat-label"><i class="bi bi-speedometer me-1"></i>平均完了率</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-warning" id="allCompleted">-</div>
                        <div class="stat-label"><i class="bi bi-trophy me-1"></i>全動画完了者</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フィルター&エクスポート -->
        <div class="filter-toolbar d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <div>
                    <label class="form-label mb-0 small text-muted">部署フィルター</label>
                    <select id="deptFilter" class="form-select form-select-sm" style="width: auto;">
                        <option value="">すべての部署</option>
                    </select>
                </div>
                <div>
                    <label class="form-label mb-0 small text-muted">ステータス</label>
                    <select id="statusFilter" class="form-select form-select-sm" style="width: auto;">
                        <option value="">全ユーザー</option>
                        <option value="completed">全動画完了</option>
                        <option value="in_progress">視聴中</option>
                        <option value="not_started">未視聴</option>
                    </select>
                </div>
                <div>
                    <label class="form-label mb-0 small text-muted">検索</label>
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="ユーザー名で検索..." style="width: 200px;">
                </div>
            </div>
            <button class="btn export-btn btn-sm" onclick="exportCSV()">
                <i class="bi bi-download me-1"></i>CSV出力
            </button>
        </div>

        <div class="row">
            <!-- ユーザー別完了状況チャート -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h5><i class="bi bi-pie-chart me-2"></i>完了状況の内訳</h5>
                    <canvas id="completionPieChart" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h5><i class="bi bi-building me-2"></i>部署別 平均完了率</h5>
                    <canvas id="deptBarChart" height="200"></canvas>
                </div>
            </div>

            <!-- ユーザー×動画 マトリクステーブル -->
            <div class="col-md-8">
                <div class="table-container">
                    <h5><i class="bi bi-table me-2"></i>ユーザー別 動画視聴進捗</h5>
                    <div class="table-responsive mt-3">
                        <table class="table table-hover table-sm align-middle" id="progressTable">
                            <thead class="table-light" id="progressTableHead">
                                <!-- Dynamic headers -->
                            </thead>
                            <tbody id="progressTableBody">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noDataMessage" class="text-center text-muted py-4 d-none">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">該当するデータがありません</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ユーザー詳細モーダル -->
        <div class="modal fade" id="userDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                        <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i><span id="modalUserName"></span></h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = null;
        let completionPieChart = null;
        let deptBarChart = null;

        function progressColor(pct) {
            if (pct >= 90) return '#2a9d8f';
            if (pct >= 50) return '#f4a261';
            if (pct >= 25) return '#667eea';
            return '#e9ecef';
        }

        function statusBadge(pct) {
            if (pct >= 90) return '<span class="badge badge-complete"><i class="bi bi-check-circle me-1"></i>完了</span>';
            if (pct > 0) return '<span class="badge badge-in-progress"><i class="bi bi-play-circle me-1"></i>視聴中</span>';
            return '<span class="badge badge-not-started"><i class="bi bi-circle me-1"></i>未視聴</span>';
        }

        function statusIcon(pct) {
            if (pct >= 90) return '<i class="bi bi-check-circle-fill status-icon-complete" title="完了 (' + Math.round(pct) + '%)"></i>';
            if (pct > 0) return '<i class="bi bi-play-circle-fill status-icon-in-progress" title="視聴中 (' + Math.round(pct) + '%)"></i>';
            return '<i class="bi bi-circle status-icon-not-started" title="未視聴"></i>';
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin/user-progress');
                allData = await res.json();
                
                // Populate department filter
                const deptSelect = document.getElementById('deptFilter');
                if (allData.departments) {
                    allData.departments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.name;
                        deptSelect.appendChild(opt);
                    });
                }

                renderAll();
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }

        function getFilteredUsers() {
            if (!allData) return [];
            let users = allData.users;
            
            const deptId = document.getElementById('deptFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            if (deptId) {
                users = users.filter(u => u.department_id == deptId);
            }
            if (status === 'completed') {
                users = users.filter(u => u.all_completed);
            } else if (status === 'in_progress') {
                users = users.filter(u => !u.all_completed && u.videos_started > 0);
            } else if (status === 'not_started') {
                users = users.filter(u => u.videos_started === 0);
            }
            if (search) {
                users = users.filter(u => u.username.toLowerCase().includes(search) || 
                                          (u.department_name || '').toLowerCase().includes(search));
            }
            return users;
        }

        function renderAll() {
            const users = getFilteredUsers();
            renderSummary(users);
            renderTable(users);
            renderCharts(users);
        }

        function renderSummary(users) {
            document.getElementById('totalUsers').textContent = allData.users.length;
            
            const activeCount = users.filter(u => u.videos_started > 0).length;
            document.getElementById('activeUsers').textContent = activeCount;

            const avgComp = users.length > 0 
                ? Math.round(users.reduce((s, u) => s + u.avg_progress, 0) / users.length)
                : 0;
            document.getElementById('avgCompletion').textContent = avgComp + '%';

            const allCompletedCount = users.filter(u => u.all_completed).length;
            document.getElementById('allCompleted').textContent = allCompletedCount;
        }

        function renderTable(users) {
            const videos = allData.videos;
            const thead = document.getElementById('progressTableHead');
            const tbody = document.getElementById('progressTableBody');
            const noData = document.getElementById('noDataMessage');

            // Build header
            let headerHtml = '<tr><th style="min-width:120px;">ユーザー</th><th>部署</th><th>ステータス</th>';
            videos.forEach(v => {
                const shortTitle = v.title.length > 12 ? v.title.substring(0, 12) + '…' : v.title;
                headerHtml += `<th class="text-center" style="min-width:80px;" title="${v.title}"><small>${shortTitle}</small></th>`;
            });
            headerHtml += '<th class="text-center">全体進捗</th></tr>';
            thead.innerHTML = headerHtml;

            if (users.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('d-none');
                return;
            }
            noData.classList.add('d-none');

            // Build rows
            tbody.innerHTML = users.map(user => {
                let row = `<tr class="user-detail-row" onclick="showUserDetail(${user.id})">`;
                row += `<td><strong>${user.username}</strong></td>`;
                row += `<td><small class="text-muted">${user.department_name || '未配属'}</small></td>`;
                
                // Overall status
                if (user.all_completed) {
                    row += '<td><span class="badge badge-complete"><i class="bi bi-check-circle me-1"></i>全完了</span></td>';
                } else if (user.videos_started > 0) {
                    row += '<td><span class="badge badge-in-progress"><i class="bi bi-play-circle me-1"></i>視聴中</span></td>';
                } else {
                    row += '<td><span class="badge badge-not-started"><i class="bi bi-circle me-1"></i>未視聴</span></td>';
                }

                // Per-video progress
                videos.forEach(v => {
                    const vp = user.video_progress[v.id];
                    if (vp) {
                        const pct = Math.round(vp.progress_percent);
                        const color = progressColor(pct);
                        row += `<td class="text-center progress-cell">
                            <div class="progress mb-1"><div class="progress-bar" style="width:${pct}%; background-color:${color};"></div></div>
                            <small style="color:${color}; font-weight:600;">${pct}%</small>
                        </td>`;
                    } else {
                        row += '<td class="text-center"><small class="text-muted">-</small></td>';
                    }
                });

                // Overall progress
                const avgProg = Math.round(user.avg_progress);
                const avgColor = progressColor(avgProg);
                row += `<td class="text-center">
                    <div class="progress mb-1" style="min-width:60px;"><div class="progress-bar" style="width:${avgProg}%; background-color:${avgColor};"></div></div>
                    <strong style="color:${avgColor};">${avgProg}%</strong>
                </td>`;
                
                row += '</tr>';
                return row;
            }).join('');
        }

        function renderCharts(users) {
            // Pie chart: completion status breakdown
            const completedCount = users.filter(u => u.all_completed).length;
            const inProgressCount = users.filter(u => !u.all_completed && u.videos_started > 0).length;
            const notStartedCount = users.filter(u => u.videos_started === 0).length;

            if (completionPieChart) completionPieChart.destroy();
            const pieCtx = document.getElementById('completionPieChart').getContext('2d');
            completionPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['全動画完了', '視聴中', '未視聴'],
                    datasets: [{
                        data: [completedCount, inProgressCount, notStartedCount],
                        backgroundColor: ['#2a9d8f', '#f4a261', '#e9ecef'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15 } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = total > 0 ? Math.round(ctx.raw / total * 100) : 0;
                                    return `${ctx.label}: ${ctx.raw}人 (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Dept bar chart
            if (deptBarChart) deptBarChart.destroy();
            const deptMap = {};
            users.forEach(u => {
                const dn = u.department_name || '未配属';
                if (!deptMap[dn]) deptMap[dn] = { total: 0, count: 0 };
                deptMap[dn].total += u.avg_progress;
                deptMap[dn].count += 1;
            });
            const deptLabels = Object.keys(deptMap);
            const deptAvgs = deptLabels.map(d => Math.round(deptMap[d].total / deptMap[d].count));
            const deptColors = deptAvgs.map(p => progressColor(p));

            if (deptLabels.length > 0) {
                const barCtx = document.getElementById('deptBarChart').getContext('2d');
                deptBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: deptLabels,
                        datasets: [{
                            label: '平均完了率 (%)',
                            data: deptAvgs,
                            backgroundColor: deptColors,
                            borderRadius: 6,
                            barThickness: 28
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                        }
                    }
                });
            }
        }

        function showUserDetail(userId) {
            const user = allData.users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('modalUserName').textContent = `${user.username}（${user.department_name || '未配属'}）`;
            
            let html = '<div class="row mb-3">';
            html += `<div class="col-4 text-center"><div class="h4 text-primary">${user.videos_completed}</div><small class="text-muted">完了動画数</small></div>`;
            html += `<div class="col-4 text-center"><div class="h4 text-info">${Math.round(user.avg_progress)}%</div><small class="text-muted">平均進捗</small></div>`;
            html += `<div class="col-4 text-center"><div class="h4 text-warning">${user.videos_started}</div><small class="text-muted">視聴開始済み</small></div>`;
            html += '</div>';
            
            html += '<table class="table table-sm"><thead><tr><th>動画タイトル</th><th>カテゴリー</th><th>進捗</th><th>ステータス</th><th>最終視聴日</th></tr></thead><tbody>';
            
            allData.videos.forEach(v => {
                const vp = user.video_progress[v.id];
                if (vp) {
                    const pct = Math.round(vp.progress_percent);
                    const color = progressColor(pct);
                    html += `<tr>
                        <td>${v.title}</td>
                        <td><small class="text-muted">${v.category_name || '-'}</small></td>
                        <td class="progress-cell">
                            <div class="progress mb-1"><div class="progress-bar" style="width:${pct}%; background-color:${color};"></div></div>
                            <small style="color:${color}; font-weight:600;">${pct}%</small>
                        </td>
                        <td>${statusBadge(pct)}</td>
                        <td><small class="text-muted">${vp.updated_at || '-'}</small></td>
                    </tr>`;
                } else {
                    html += `<tr>
                        <td>${v.title}</td>
                        <td><small class="text-muted">${v.category_name || '-'}</small></td>
                        <td>-</td>
                        <td>${statusBadge(0)}</td>
                        <td>-</td>
                    </tr>`;
                }
            });
            html += '</tbody></table>';
            
            document.getElementById('modalBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('userDetailModal')).show();
        }

        function exportCSV() {
            if (!allData) return;
            const users = getFilteredUsers();
            const videos = allData.videos;
            
            // BOM for Excel Japanese support
            let csv = '\uFEFF';
            
            // Header
            let headers = ['ユーザー名', '部署', 'ステータス'];
            videos.forEach(v => headers.push(v.title));
            headers.push('全体平均進捗(%)');
            csv += headers.join(',') + '\n';
            
            // Rows
            users.forEach(user => {
                let row = [
                    user.username,
                    user.department_name || '未配属',
                    user.all_completed ? '全完了' : (user.videos_started > 0 ? '視聴中' : '未視聴')
                ];
                videos.forEach(v => {
                    const vp = user.video_progress[v.id];
                    row.push(vp ? Math.round(vp.progress_percent) + '%' : '未視聴');
                });
                row.push(Math.round(user.avg_progress) + '%');
                csv += row.map(c => `"${c}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ユーザー視聴状況_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Event listeners
        document.getElementById('deptFilter').addEventListener('change', renderAll);
        document.getElementById('statusFilter').addEventListener('change', renderAll);
        document.getElementById('searchInput').addEventListener('input', renderAll);

        // Load data
        loadData();
    </script>
</body>
</html>
