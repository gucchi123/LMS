<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクセス分析 - LMS</title>
    {% include 'ga4_tracking.html' %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body { background-color: #f8f9fa; }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .stat-card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-card .stat-label { color: #6c757d; font-size: 0.85rem; }
        .chart-container { 
            background: #fff; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .table-container {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/courses">
                <i class="bi bi-mortarboard-fill"></i> Rakuten AI for Business トレーニング
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3"><i class="bi bi-person-circle"></i> {{ session.get('username', '') }}</span>
                <a href="/admin" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-gear me-1"></i>管理画面</a>
                <a href="/admin/user-progress" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-people-fill me-1"></i>ユーザー視聴状況</a>
                <a href="/admin/video-analytics" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-camera-video me-1"></i>動画視聴分析</a>
                <a href="/admin/analytics" class="btn btn-light btn-sm me-2"><i class="bi bi-graph-up me-1"></i>アクセス分析</a>
                <a href="/my-progress" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-graph-up-arrow me-1"></i>マイ視聴状況</a>
                <a href="/logout" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right me-1"></i>ログアウト</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-graph-up me-2"></i>アクセス分析ダッシュボード</h2>
            <div>
                <select id="periodSelect" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="7">過去7日</option>
                    <option value="30" selected>過去30日</option>
                    <option value="90">過去90日</option>
                </select>
            </div>
        </div>

        <!-- 概要カード -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-primary" id="totalAccess">-</div>
                        <div class="stat-label">総アクセス数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-success" id="uniqueUsers">-</div>
                        <div class="stat-label">ユニークユーザー数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-info" id="avgDuration">-</div>
                        <div class="stat-label">平均応答時間 (ms)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-value text-warning" id="dailyAvg">-</div>
                        <div class="stat-label">日平均アクセス</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 日別アクセスチャート -->
            <div class="col-md-8">
                <div class="chart-container">
                    <h5><i class="bi bi-bar-chart me-2"></i>日別アクセス推移</h5>
                    <canvas id="dailyChart" height="80"></canvas>
                </div>
            </div>
            <!-- ページ別アクセスチャート -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h5><i class="bi bi-pie-chart me-2"></i>ページ別アクセス (Top 10)</h5>
                    <canvas id="pageChart" height="160"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 人気ページランキング -->
            <div class="col-md-6">
                <div class="table-container">
                    <h5><i class="bi bi-trophy me-2"></i>ページアクセスランキング</h5>
                    <table class="table table-hover table-sm mt-3">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>パス</th>
                                <th>アクセス数</th>
                                <th>平均応答 (ms)</th>
                            </tr>
                        </thead>
                        <tbody id="pagesTable"></tbody>
                    </table>
                </div>
            </div>
            <!-- ユーザー別アクセス -->
            <div class="col-md-6">
                <div class="table-container">
                    <h5><i class="bi bi-people me-2"></i>ユーザーアクティビティ</h5>
                    <table class="table table-hover table-sm mt-3">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ユーザー</th>
                                <th>会社</th>
                                <th>アクセス数</th>
                                <th>最終アクセス</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dailyChart = null;
        let pageChart = null;

        async function loadAnalytics() {
            const days = document.getElementById('periodSelect').value;
            
            try {
                const res = await fetch(`/api/admin/analytics/summary?days=${days}`);
                const data = await res.json();

                // 概要カード
                document.getElementById('totalAccess').textContent = (data.total.total || 0).toLocaleString();
                document.getElementById('uniqueUsers').textContent = (data.total.unique_users || 0).toLocaleString();
                document.getElementById('avgDuration').textContent = Math.round(data.total.avg_duration || 0).toLocaleString();
                
                const dailyAvg = data.daily.length > 0 ? Math.round(data.total.total / data.daily.length) : 0;
                document.getElementById('dailyAvg').textContent = dailyAvg.toLocaleString();

                // 日別チャート
                if (dailyChart) dailyChart.destroy();
                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                dailyChart = new Chart(dailyCtx, {
                    type: 'bar',
                    data: {
                        labels: data.daily.map(d => d.date),
                        datasets: [{
                            label: 'アクセス数',
                            data: data.daily.map(d => d.count),
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: { ticks: { maxRotation: 45 } }
                        }
                    }
                });

                // ページ別チャート (Top 10)
                if (pageChart) pageChart.destroy();
                const pageCtx = document.getElementById('pageChart').getContext('2d');
                const top10Pages = data.pages.slice(0, 10);
                const colors = [
                    '#667eea', '#764ba2', '#f093fb', '#e63946', '#f4a261',
                    '#2a9d8f', '#e76f51', '#264653', '#8338ec', '#06d6a0'
                ];
                pageChart = new Chart(pageCtx, {
                    type: 'doughnut',
                    data: {
                        labels: top10Pages.map(p => p.path.length > 25 ? p.path.substring(0, 25) + '...' : p.path),
                        datasets: [{
                            data: top10Pages.map(p => p.count),
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 10 } } }
                        }
                    }
                });

                // ページテーブル
                const pagesBody = document.getElementById('pagesTable');
                pagesBody.innerHTML = data.pages.map((p, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td><code>${p.path}</code></td>
                        <td><span class="badge bg-primary">${p.count}</span></td>
                        <td>${Math.round(p.avg_duration || 0)}</td>
                    </tr>
                `).join('');

                // ユーザーテーブル
                const usersBody = document.getElementById('usersTable');
                usersBody.innerHTML = data.user_access.map((u, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${u.username}</td>
                        <td>${u.company_name || '-'}</td>
                        <td><span class="badge bg-success">${u.access_count}</span></td>
                        <td><small>${u.last_access ? new Date(u.last_access).toLocaleString('ja-JP') : '-'}</small></td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error('Analytics load error:', err);
            }
        }

        document.getElementById('periodSelect').addEventListener('change', loadAnalytics);
        loadAnalytics();
    </script>
</body>
</html>
